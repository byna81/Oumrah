<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#059669">
<title>Gestion Groupe Oumrah</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{padding-bottom:80px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#d1fae5 0%,#99f6e4 50%,#a5f3fc 100%);min-height:100vh;padding-bottom:100px}
.container{max-width:600px;margin:0 auto;padding:20px 15px}
.card{background:white;border-radius:20px;padding:25px;box-shadow:0 4px 20px rgba(0,0,0,0.08);margin-bottom:20px;transition:all 0.3s}
.card:hover{box-shadow:0 8px 30px rgba(0,0,0,0.12);transform:translateY(-2px)}
h1{color:#047857;font-size:28px;margin-bottom:10px;text-align:center}
h2{color:#047857;font-size:22px;margin-bottom:15px}
h3{color:#059669;font-size:18px;margin-bottom:10px}
p{color:#4b5563;line-height:1.6;margin-bottom:10px}
button{width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;margin-bottom:10px}
.btn-primary{background:linear-gradient(135deg,#059669 0%,#0d9488 100%);color:white;box-shadow:0 4px 15px rgba(5,150,105,0.3);transition:all 0.3s}
.btn-primary:hover{box-shadow:0 6px 20px rgba(5,150,105,0.4);transform:translateY(-2px)}
.btn-primary:active{transform:scale(0.98)}
.btn-secondary{background:white;border:2px solid #059669;color:#059669}
.btn-small{width:auto;padding:8px 15px;font-size:14px;display:inline-block}
.btn-danger{background:#ef4444;color:white}
.btn-success{background:#10b981;color:white}
.btn-warning{background:#f59e0b;color:white}
.btn-completed{background:#10b981;color:white}
input,select,textarea{width:100%;padding:12px;border:2px solid #d1d5db;border-radius:10px;font-size:16px;margin-bottom:15px}
textarea{min-height:100px;font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:#059669}
.hidden{display:none}
.tab-bar{background:white;position:sticky;top:0;z-index:100;display:flex;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow-x:auto}
.tab{flex:1;min-width:70px;padding:15px 10px;text-align:center;border:none;background:white;color:#6b7280;font-weight:600;font-size:12px;border-bottom:3px solid transparent;cursor:pointer;white-space:nowrap}
.tab.active{color:#059669;border-top-color:#059669}.tab.active .tab-icon{transform:scale(1.1)}
.header{background:white;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);margin-bottom:20px}
.profile-section{background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);padding:20px;border-radius:15px;text-align:center;margin-bottom:20px;border:2px solid #059669}
.profile-photo{width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);margin:0 auto 15px;display:flex;align-items:center;justify-content:center;color:white;font-size:40px;font-weight:bold;box-shadow:0 4px 15px rgba(5,150,105,0.3);overflow:hidden}
.profile-photo img{width:100%;height:100%;object-fit:cover}
.icon-circle{width:60px;height:60px;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);border-radius:50%;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(5,150,105,0.3)}
.code-display{background:#d1fae5;padding:15px;border-radius:10px;text-align:center;font-family:monospace;font-size:24px;font-weight:bold;color:#047857;margin:15px 0}
.pilgrim-item,.message-item,.activity-item,.question-item{background:#f9fafb;padding:15px;border-radius:10px;margin-bottom:10px;border:2px solid #e5e7eb}
.status-online,.status-offline{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:5px}
.status-online{background:#10b981}
.status-offline{background:#6b7280}
.badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;margin:5px 5px 5px 0}
.badge-present{background:#dcfce7;color:#166534}
.badge-absent{background:#fee2e2;color:#991b1b}
.badge-info{background:#dbeafe;color:#1e40af}
.badge-warning{background:#fef3c7;color:#92400e}
.badge-success{background:#d1fae5;color:#065f46}
.progress-bar{width:100%;height:12px;background:#e5e7eb;border-radius:15px;overflow:hidden;margin:10px 0;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)}
.progress-fill{height:100%;background:linear-gradient(90deg,#059669 0%,#10b981 100%);transition:width 0.3s}
.progress-text{font-size:14px;font-weight:600;color:#059669;text-align:center;margin-top:5px}
.rite-item{border:2px solid #d1fae5;border-radius:15px;margin-bottom:15px;overflow:hidden}
.rite-item.completed{border-color:#10b981;background:#f0fdf4}
.rite-header{padding:20px;background:white;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.rite-header:active{background:#f0fdf4}
.rite-number{width:40px;height:40px;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:18px;margin-right:15px;flex-shrink:0}
.rite-number.completed{background:linear-gradient(135deg,#10b981 0%,#059669 100%)}
.rite-content{padding:20px;background:#f0fdf4;border-top:2px solid #d1fae5}
.dua-box{background:white;padding:15px;border-radius:10px;margin-bottom:10px;border:1px solid #d1fae5}
.arabic-text{font-size:24px;line-height:1.8;text-align:right;direction:rtl;color:#1f2937}
.phonetic-text{font-style:italic;color:#6b7280;font-size:14px}
.translation-text{color:#374151;font-size:14px}
.counter-circle{width:150px;height:150px;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:20px auto;box-shadow:0 10px 30px rgba(5,150,105,0.4)}
.counter-number{font-size:60px;font-weight:bold;color:white}
.success-box{background:#dcfce7;border:2px solid #22c55e;padding:15px;border-radius:10px;text-align:center;margin-bottom:15px}
.success-text{color:#166534;font-weight:bold;font-size:16px}
.flex-row{display:flex;gap:10px;align-items:center}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.guide-location-card{background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);border:2px solid #3b82f6;border-radius:15px;padding:20px;margin-bottom:20px}
.distance-display{font-size:32px;font-weight:bold;color:#1e40af;text-align:center;margin:10px 0}
.map-placeholder{background:linear-gradient(135deg,#d1fae5 0%,#a5f3fc 100%);height:200px;border-radius:15px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;border:2px solid #059669}
.question-response{background:#f0fdf4;padding:10px;border-left:4px solid #059669;margin-top:10px;border-radius:5px}
ol{margin-left:20px;margin-bottom:15px}
ol li{margin-bottom:8px;color:#374151}
.label{font-size:12px;font-weight:600;color:#047857;margin-bottom:5px;display:block}
.message-time{font-size:12px;color:#6b7280}
.message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.checkmark{color:#10b981;font-size:20px;margin-left:10px}
.checkbox-item{display:flex;align-items:center;padding:10px;margin-bottom:5px;background:white;border-radius:8px}
.checkbox-item input[type="checkbox"]{width:20px;height:20px;margin-right:10px}
.audio-player{background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);border:2px solid #3b82f6;border-radius:15px;padding:20px;margin:20px 0}
.audio-controls{display:flex;justify-content:center;align-items:center;gap:15px;margin:15px 0}
.audio-btn{width:60px;height:60px;border-radius:50%;border:none;font-size:20px;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;background:white}
.audio-btn:hover{transform:scale(1.1)}
.audio-btn:active{transform:scale(0.95)}
.audio-text{background:white;padding:15px;border-radius:10px;text-align:center;font-size:18px;margin-bottom:15px;direction:rtl}
.audio-progress{width:100%;height:8px;background:#bfdbfe;border-radius:10px;margin:15px 0;position:relative}

@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.card,.rite-item,.pilgrim-item,.activity-item{animation:fadeIn 0.4s ease-out}

@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.card{animation:fadeIn 0.5s ease-out}
.rite-item{animation:slideUp 0.4s ease-out}
.rite-item:nth-child(1){animation-delay:0s}
.rite-item:nth-child(2){animation-delay:0.1s}
.rite-item:nth-child(3){animation-delay:0.2s}
.rite-item:nth-child(4){animation-delay:0.3s}
.rite-item:nth-child(5){animation-delay:0.4s}

.talkie-btn{
  position:fixed !important;
  bottom:110px !important;
  right:15px !important;
  width:80px !important;
  height:80px !important;
  border-radius:50% !important;
  background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%) !important;
  color:white !important;
  border:5px solid white !important;
  cursor:pointer !important;
  box-shadow:0 15px 50px rgba(239,68,68,0.7) !important;
  z-index:9999 !important;
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
  justify-content:center !important;
  gap:4px !important;
  transition:all 0.3s !important;
  animation:bounceTalkie 2s infinite !important;
}
@keyframes bounceTalkie{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
}
.talkie-btn:active{
  transform:scale(0.95);
}
.talkie-icon{
  font-size:32px;
  line-height:1;
}
.talkie-text{
  font-size:9px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.talkie-btn.recording{
  background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);
  animation:talkiePulse 1s infinite;
  box-shadow:0 8px 40px rgba(239,68,68,0.6);
}
@keyframes talkiePulse{
  0%,100%{transform:scale(1);box-shadow:0 8px 40px rgba(239,68,68,0.6)}
  50%{transform:scale(1.05);box-shadow:0 12px 50px rgba(239,68,68,0.8)}
}

.voice-message-card{
  background:white;
  border-radius:20px;
  padding:20px;
  margin-bottom:15px;
  box-shadow:0 6px 20px rgba(0,0,0,0.08);
  border:2px solid #d1fae5;
  transition:all 0.3s;
  animation:fadeIn 0.5s ease-out;
}
.voice-message-card:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(0,0,0,0.12);
}
.voice-message-header{
  display:flex;
  align-items:center;
  margin-bottom:15px;
  gap:10px;
}
.voice-avatar{
  width:45px;
  height:45px;
  border-radius:50%;
  background:linear-gradient(135deg,#059669 0%,#0d9488 100%);
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:18px;
  flex-shrink:0;
  box-shadow:0 4px 12px rgba(5,150,105,0.3);
}
.voice-play-btn{
  width:100%;
  padding:16px;
  background:linear-gradient(135deg,#059669 0%,#0d9488 100%);
  color:white;
  border:none;
  border-radius:15px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  font-weight:600;
  font-size:15px;
  box-shadow:0 6px 20px rgba(5,150,105,0.3);
  transition:all 0.3s;
}
.voice-play-btn:active{
  transform:scale(0.98);
  box-shadow:0 4px 15px rgba(5,150,105,0.4);
}
.voice-delete-btn{
  background:#ef4444;
  color:white;
  border:none;
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer;
  font-size:18px;
  transition:all 0.3s;
  box-shadow:0 4px 12px rgba(239,68,68,0.3);
}
.voice-delete-btn:active{
  transform:scale(0.95);
}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// Configuration Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCEtBQp2PNeSB-w_Yl877VfzLr5vdfSr-0",
  authDomain: "umrah-groupe-claud.firebaseapp.com",
  databaseURL: "https://umrah-groupe-claud-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "umrah-groupe-claud",
  storageBucket: "umrah-groupe-claud.firebasestorage.app",
  messagingSenderId: "803001314265",
  appId: "1:803001314265:web:e5075de940958586a507c8"
};

// Initialiser Firebase
try {
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  window.db = firebase.database();
  console.log('‚úÖ Firebase initialis√©');
  console.log('‚úÖ Database URL:', firebaseConfig.databaseURL);
  
  // Test de connexion
  window.window.db.ref('.info/connected').on('value', snap => {
    if (snap.val() === true) {
      console.log('‚úÖ Connect√© √† Firebase');
    } else {
      console.log('‚ùå D√©connect√© de Firebase');
    }
  });
} catch(err) {
  console.error('‚ùå Erreur Firebase:', err);
}
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// Attendre que Firebase soit charg√©
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    if (typeof firebase !== 'undefined') {
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyCEtBQp2PNeSB-w_Yl877VfzLr5vdfSr-0",
          authDomain: "umrah-groupe-claud.firebaseapp.com",
          databaseURL: "https://umrah-groupe-claud-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "umrah-groupe-claud",
          storageBucket: "umrah-groupe-claud.firebasestorage.app",
          messagingSenderId: "803001314265",
          appId: "1:803001314265:web:e5075de940958586a507c8"
        };
        
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        
        window.db = firebase.database();
        window.firebaseReady = true;
        console.log('‚úÖ Firebase initialis√©');
        console.log('‚úÖ Database URL:', firebaseConfig.databaseURL);
        
        // Test de connexion
        window.db.ref('.info/connected').on('value', function(snap) {
          if (snap.val() === true) {
            console.log('‚úÖ Connect√© √† Firebase');
          } else {
            console.log('‚ùå D√©connect√© de Firebase');
          }
        });
      } catch(err) {
        console.error('‚ùå Erreur Firebase:', err);
        window.firebaseReady = false;
      }
    } else {
      console.error('‚ùå Firebase SDK non charg√©');
      window.firebaseReady = false;
    }
  }, 500);
});
</script>
</head>
<body>
<div id="app"></div>
<script>
let S={lang:localStorage.getItem('appLang')||'fr',showLangSelector:!localStorage.getItem('appLang'),userType:null,isRecording:false,voiceMessages:[],isOnline:navigator.onLine,fbListeners:[],userName:'',userPhoto:null,userHotel:'',userRoom:'',pilgrimCode:'',groupCode:'',groupName:'',currentGroup:null,activeTab:'rites',expandedRite:null,tawafCount:0,saiCount:0,messages:[],pilgrims:[],activities:[],questions:[],completedSteps:{},pilgrimPresence:{},guideLocation:{lat:21.4225,lng:39.8262},showAddMessage:false,showAddPilgrim:false,showAddActivity:false,showAskQuestion:false,showEditPilgrim:false,editPilgrimId:null,viewPilgrimProgress:null,viewQuestions:false,showReconnect:false,guideCode:'',activityResponses:JSON.parse(localStorage.getItem('activityResponses')||'{}'),audioState:{}};
const T={fr:{appTitle:"Gestion Groupe Oumrah",guide:"Guide",pilgrims:"P√®lerins",userType:"Choisissez votre r√¥le",enterName:"Entrez votre nom complet",uploadPhoto:"Ajouter une photo (optionnel)",create:"Cr√©er un groupe",join:"Rejoindre",enterCode:"Entrez le code du groupe",yourCode:"Votre code de groupe :",shareCode:"Partagez ce code avec vos p√®lerins",rites:"Rites",detailedGuide:"Guide d√©taill√©",messages:"Messages",rooms:"Chambres",map:"Carte",presence:"Pr√©sence",progress:"Progression",guideLocation:"Localisation Guide",activities:"Activit√©s",questions:"Questions au Guide",steps:"√âtapes",invocation:"Invocation",phonetic:"Phon√©tique",translation:"Traduction",counter:"Compteur",round:"Tour",trip:"Trajet",reset:"R√©initialiser",tawafComplete:"Tawaf termin√© ! 7 tours accomplis ‚úì",saiComplete:"Sa'i termin√© ! 7 trajets accomplis ‚úì",back:"‚Üê Retour",addMessage:"Nouveau message",messageTitle:"Titre du message",messageContent:"Contenu du message",send:"Envoyer",cancel:"Annuler",noMessages:"Aucun message pour le moment",addPilgrim:"Ajouter un p√®lerin",pilgrimName:"Nom du p√®lerin",roomNumber:"Num√©ro de chambre",floor:"√âtage",save:"Enregistrer",noPilgrims:"Aucun p√®lerin enregistr√©",room:"Chambre",online:"En ligne",offline:"Hors ligne",addActivity:"Nouvelle activit√©",activityName:"Nom de l'activit√©",activityLocation:"Lieu",activityTime:"Heure",noActivities:"Aucune activit√© planifi√©e",markPresence:"Marquer les pr√©sences",present:"Pr√©sent",absent:"Absent",presenceCount:"pr√©sents",delete:"Supprimer",myProgress:"Ma progression",completed:"‚úì Termin√©",notStarted:"Pas commenc√©",markComplete:"Marquer comme termin√©",viewProgress:"Voir la progression",pilgrimProgress:"Progression du p√®lerin",of:"sur",stepsCompleted:"√©tapes termin√©es",guideDistance:"Distance du guide",meters:"m√®tres",findGuide:"Localiser le guide",askQuestion:"Poser une question",questionPlaceholder:"D√©crivez votre probl√®me ou question...",yourQuestions:"Vos questions",noQuestions:"Aucune question pos√©e",awaitingResponse:"En attente de r√©ponse",answered:"R√©pondu",validatePresence:"Valider ma pr√©sence",presenceValidated:"‚úì Pr√©sence valid√©e",myActivities:"Mes activit√©s",answer:"R√©pondre",response:"R√©ponse",pilgrimsQuestions:"Questions des p√®lerins",groupName:"Nom du groupe",enterGroupName:"Ex: Oumrah Janvier 2026",sendWhatsApp:"Envoyer sur WhatsApp",codesSent:"Codes envoy√©s"},en:{appTitle:"Umrah Group Management",guide:"Guide",pilgrims:"Pilgrims",userType:"Choose your role",enterName:"Enter your full name",uploadPhoto:"Add photo (optional)",create:"Create group",join:"Join",enterCode:"Enter group code",yourCode:"Your group code:",shareCode:"Share this code with your pilgrims",rites:"Rites",detailedGuide:"Detailed Guide",messages:"Messages",rooms:"Rooms",map:"Map",presence:"Attendance",progress:"Progress",guideLocation:"Guide Location",activities:"Activities",questions:"Questions to Guide",steps:"Steps",invocation:"Invocation",phonetic:"Phonetic",translation:"Translation",counter:"Counter",round:"Round",trip:"Trip",reset:"Reset",tawafComplete:"Tawaf completed! 7 rounds done ‚úì",saiComplete:"Sa'i completed! 7 trips done ‚úì",back:"‚Üê Back",addMessage:"New message",messageTitle:"Message title",messageContent:"Message content",send:"Send",cancel:"Cancel",noMessages:"No messages yet",addPilgrim:"Add pilgrim",pilgrimName:"Pilgrim name",roomNumber:"Room number",floor:"Floor",save:"Save",noPilgrims:"No pilgrims registered",room:"Room",online:"Online",offline:"Offline",addActivity:"New activity",activityName:"Activity name",activityLocation:"Location",activityTime:"Time",noActivities:"No activities planned",markPresence:"Mark attendance",present:"Present",absent:"Absent",presenceCount:"present",delete:"Delete",myProgress:"My progress",completed:"‚úì Completed",notStarted:"Not started",markComplete:"Mark as completed",viewProgress:"View progress",pilgrimProgress:"Pilgrim progress",of:"of",stepsCompleted:"steps completed",guideDistance:"Distance to guide",meters:"meters",findGuide:"Find guide",askQuestion:"Ask question",questionPlaceholder:"Describe your issue or question...",yourQuestions:"Your questions",noQuestions:"No questions asked",awaitingResponse:"Awaiting response",answered:"Answered",validatePresence:"Validate my presence",presenceValidated:"‚úì Presence validated",myActivities:"My activities",answer:"Answer",response:"Response",pilgrimsQuestions:"Pilgrims questions",groupName:"Group name",enterGroupName:"Ex: Umrah January 2026",sendWhatsApp:"Send on WhatsApp",codesSent:"Codes sent"}};
const RITES={fr:[{id:1,title:"Ihram",description:"√âtat de sacralisation avant d'entrer dans les lieux saints",steps:["Se purifier (ghusl) et porter les v√™tements d'Ihram","Formuler l'intention (niyyah) pour la Oumrah","R√©citer la Talbiyah"],dua:{arabic:"ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸé ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸéÿå ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸé ŸÑŸéÿß ÿ¥Ÿéÿ±ŸêŸäŸÉŸé ŸÑŸéŸÉŸé ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸéÿå ÿ•ŸêŸÜŸéŸë ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸé ŸàŸéÿßŸÑŸÜŸêŸëÿπŸíŸÖŸéÿ©Ÿé ŸÑŸéŸÉŸé ŸàŸéÿßŸÑŸíŸÖŸèŸÑŸíŸÉŸéÿå ŸÑŸéÿß ÿ¥Ÿéÿ±ŸêŸäŸÉŸé ŸÑŸéŸÉŸé",phonetic:"Labbayka AllƒÅhumma labbayk, labbayka lƒÅ sharƒ´ka laka labbayk, inna al-·∏•amda wa n-ni ømata laka wa l-mulk, lƒÅ sharƒ´ka lak",translation:"Me voici, √î Allah, me voici. Me voici, Tu n'as pas d'associ√©, me voici. Certes la louange, la gr√¢ce et la royaut√© T'appartiennent. Tu n'as pas d'associ√©."}},{id:2,title:"Tawaf",description:"Sept circumambulations autour de la Kaaba",steps:["Commencer au niveau de la Pierre Noire (Hajar al-Aswad)","Effectuer 7 tours autour de la Kaaba dans le sens antihoraire","Toucher ou pointer la Pierre Noire √† chaque tour si possible","R√©citer les invocations pendant le Tawaf"],dua:{arabic:"ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿßŸÑŸÑŸáŸê ŸàŸéÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ŸàŸéŸÑŸéÿß ÿ•ŸêŸÑŸéŸáŸé ÿ•ŸêŸÑŸéŸëÿß ÿßŸÑŸÑŸáŸè ŸàŸéÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè ŸàŸéŸÑŸéÿß ÿ≠ŸéŸàŸíŸÑŸé ŸàŸéŸÑŸéÿß ŸÇŸèŸàŸéŸëÿ©Ÿé ÿ•ŸêŸÑŸéŸëÿß ÿ®ŸêÿßŸÑŸÑŸáŸê",phonetic:"Sub·∏•ƒÅna LlƒÅh, wa l-·∏•amdu li-LlƒÅh, wa lƒÅ ilƒÅha illƒÅ LlƒÅh, wa LlƒÅhu akbar, wa lƒÅ ·∏•awla wa lƒÅ quwwata illƒÅ bi-LlƒÅh",translation:"Gloire √† Allah, louange √† Allah, il n'y a de divinit√© qu'Allah, Allah est le Plus Grand, il n'y a de force ni de puissance qu'en Allah."}},{id:3,title:"Pri√®re de deux unit√©s",description:"Pri√®re derri√®re Maqam Ibrahim",steps:["Se diriger vers Maqam Ibrahim apr√®s le Tawaf","Accomplir deux rak'at (unit√©s de pri√®re)","R√©citer sourate Al-Kafirun dans la 1√®re rak'a","R√©citer sourate Al-Ikhlas dans la 2√®me rak'a"],dua:{arabic:"ÿ±Ÿéÿ®ŸéŸëŸÜŸéÿß ÿ™ŸéŸÇŸéÿ®ŸéŸëŸÑŸí ŸÖŸêŸÜŸéŸëÿß ÿ•ŸêŸÜŸéŸëŸÉŸé ÿ£ŸéŸÜŸíÿ™Ÿé ÿßŸÑÿ≥ŸéŸëŸÖŸêŸäÿπŸè ÿßŸÑŸíÿπŸéŸÑŸêŸäŸÖŸè",phonetic:"RabbanƒÅ taqabbal minnƒÅ innaka anta s-samƒ´ øu l- øalƒ´m",translation:"Notre Seigneur, accepte de nous, Tu es certes Celui qui entend et qui sait."}},{id:4,title:"Sa'i",description:"Sept allers-retours entre Safa et Marwa",steps:["Arriver au pied du mont Safa et r√©citer le verset","Monter sur Safa en regardant la Kaaba","R√©citer le Takbir (3 fois)","Marcher vers Marwa (1er trajet)","R√©p√©ter jusqu'√† compl√©ter 7 trajets (fin √† Marwa)"],dua:{arabic:"ÿ•ŸêŸÜŸéŸë ÿßŸÑÿµŸéŸëŸÅŸéÿß ŸàŸéÿßŸÑŸíŸÖŸéÿ±ŸíŸàŸéÿ©Ÿé ŸÖŸêŸÜŸí ÿ¥ŸéÿπŸéÿßÿ¶Ÿêÿ±Ÿê ÿßŸÑŸÑŸéŸëŸáŸê ŸÅŸéŸÖŸéŸÜŸí ÿ≠Ÿéÿ¨ŸéŸë ÿßŸÑŸíÿ®ŸéŸäŸíÿ™Ÿé ÿ£Ÿà ÿßÿπŸíÿ™ŸéŸÖŸéÿ±Ÿé ŸÅŸéŸÑŸéÿß ÿ¨ŸèŸÜŸéÿßÿ≠Ÿé ÿπŸéŸÑŸéŸäŸíŸáŸê ÿ£ŸéŸÜŸí ŸäŸéÿ∑ŸéŸàŸéŸëŸÅŸé ÿ®ŸêŸáŸêŸÖŸéÿß ŸàŸéŸÖŸéŸÜŸí ÿ™Ÿéÿ∑ŸéŸàŸéŸëÿπŸé ÿÆŸéŸäŸíÿ±Ÿãÿß ŸÅŸéÿ•ŸêŸÜŸéŸë ÿßŸÑŸÑŸéŸëŸáŸé ÿ¥ŸéÿßŸÉŸêÿ±Ÿå ÿπŸéŸÑŸêŸäŸÖŸå ‚Ä¢ ÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿèÿå ÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿèÿå ÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè",phonetic:"Inna-s-safa wa-l-marwata min cha'aa-iri Llahi, faman hadja-l-bayta awi 'tamara fala djounaaha 'alayhi an yattawwafa bihima, wa man ta tawwa'a khayran fa inna Allaha chaa kiroun 'alim ‚Ä¢ Allahou Akbar, Allahou Akbar, Allahou Akbar",translation:"AS-SAFA et AL-MARWA sont vraiment parmi les lieux sacr√©s d'ALLAH. Donc, quiconque fait le p√®lerinage √† la Maison (Sacr√©e) ou fait la OMRA ne commet pas de p√©ch√© en faisant le va-et-vient entre ces deux monts. Et quiconque fait de son propre gr√© une bonne ≈ìuvre, alors ALLAH est Reconnaissant, Omniscient ‚Ä¢ Allah est le Plus Grand, Allah est le Plus Grand, Allah est le Plus Grand."}},{id:5,title:"Taqsir ou Halq",description:"Raccourcir ou raser les cheveux",steps:["Les hommes peuvent raser (Halq) ou raccourcir (Taqsir) leurs cheveux","Les femmes coupent l'√©quivalent d'une phalange de leurs cheveux","Ceci marque la fin de la Oumrah","L'√©tat d'Ihram prend fin"],dua:{arabic:"ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ÿßŸÑŸéŸëÿ∞ŸêŸä ŸÇŸéÿ∂ŸéŸâ ÿπŸéŸÜŸéŸëÿß ŸÜŸèÿ≥ŸèŸÉŸéŸÜŸéÿß",phonetic:"Al-·∏•amdu li-LlƒÅhi lladhƒ´ qa·∏çƒÅ  øannƒÅ nusukana",translation:"Louange √† Allah qui nous a permis d'accomplir notre rite."}}],en:[{id:1,title:"Ihram",description:"State of consecration",steps:["Perform purification (ghusl)","Make intention (niyyah)","Recite the Talbiyah"],dua:{arabic:"ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸé ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸéÿå ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸé ŸÑŸéÿß ÿ¥Ÿéÿ±ŸêŸäŸÉŸé ŸÑŸéŸÉŸé ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸéÿå ÿ•ŸêŸÜŸéŸë ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸé ŸàŸéÿßŸÑŸÜŸêŸëÿπŸíŸÖŸéÿ©Ÿé ŸÑŸéŸÉŸé ŸàŸéÿßŸÑŸíŸÖŸèŸÑŸíŸÉŸéÿå ŸÑŸéÿß ÿ¥Ÿéÿ±ŸêŸäŸÉŸé ŸÑŸéŸÉŸé",phonetic:"Labbayka AllƒÅhumma labbayk",translation:"Here I am, O Allah"}},{id:2,title:"Tawaf",description:"Seven circumambulations",steps:["Start at Black Stone","Perform 7 circles counterclockwise","Touch or point to Black Stone","Recite invocations"],dua:{arabic:"ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿßŸÑŸÑŸáŸê ŸàŸéÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ŸàŸéŸÑŸéÿß ÿ•ŸêŸÑŸéŸáŸé ÿ•ŸêŸÑŸéŸëÿß ÿßŸÑŸÑŸáŸè ŸàŸéÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè ŸàŸéŸÑŸéÿß ÿ≠ŸéŸàŸíŸÑŸé ŸàŸéŸÑŸéÿß ŸÇŸèŸàŸéŸëÿ©Ÿé ÿ•ŸêŸÑŸéŸëÿß ÿ®ŸêÿßŸÑŸÑŸáŸê",phonetic:"Sub·∏•ƒÅna LlƒÅh",translation:"Glory be to Allah"}},{id:3,title:"Two units prayer",description:"Prayer behind Maqam Ibrahim",steps:["Go to Maqam Ibrahim","Perform two rak'at","Recite Surah Al-Kafirun","Recite Surah Al-Ikhlas"],dua:{arabic:"ÿ±Ÿéÿ®ŸéŸëŸÜŸéÿß ÿ™ŸéŸÇŸéÿ®ŸéŸëŸÑŸí ŸÖŸêŸÜŸéŸëÿß ÿ•ŸêŸÜŸéŸëŸÉŸé ÿ£ŸéŸÜŸíÿ™Ÿé ÿßŸÑÿ≥ŸéŸëŸÖŸêŸäÿπŸè ÿßŸÑŸíÿπŸéŸÑŸêŸäŸÖŸè",phonetic:"RabbanƒÅ taqabbal minnƒÅ",translation:"Our Lord, accept from us"}},{id:4,title:"Sa'i",description:"Seven trips between Safa and Marwa",steps:["Arrive at mount Safa and recite verse","Climb Safa facing Kaaba","Recite Takbir (3 times)","Walk to Marwa","Complete 7 trips"],dua:{arabic:"ÿ•ŸêŸÜŸéŸë ÿßŸÑÿµŸéŸëŸÅŸéÿß ŸàŸéÿßŸÑŸíŸÖŸéÿ±ŸíŸàŸéÿ©Ÿé ŸÖŸêŸÜŸí ÿ¥ŸéÿπŸéÿßÿ¶Ÿêÿ±Ÿê ÿßŸÑŸÑŸéŸëŸáŸê ŸÅŸéŸÖŸéŸÜŸí ÿ≠Ÿéÿ¨ŸéŸë ÿßŸÑŸíÿ®ŸéŸäŸíÿ™Ÿé ÿ£Ÿà ÿßÿπŸíÿ™ŸéŸÖŸéÿ±Ÿé ŸÅŸéŸÑŸéÿß ÿ¨ŸèŸÜŸéÿßÿ≠Ÿé ÿπŸéŸÑŸéŸäŸíŸáŸê ÿ£ŸéŸÜŸí ŸäŸéÿ∑ŸéŸàŸéŸëŸÅŸé ÿ®ŸêŸáŸêŸÖŸéÿß ŸàŸéŸÖŸéŸÜŸí ÿ™Ÿéÿ∑ŸéŸàŸéŸëÿπŸé ÿÆŸéŸäŸíÿ±Ÿãÿß ŸÅŸéÿ•ŸêŸÜŸéŸë ÿßŸÑŸÑŸéŸëŸáŸé ÿ¥ŸéÿßŸÉŸêÿ±Ÿå ÿπŸéŸÑŸêŸäŸÖŸå ‚Ä¢ ÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿèÿå ÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿèÿå ÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè",phonetic:"Inna-s-safa wa-l-marwata min cha'aa-iri Llahi ‚Ä¢ Allahou Akbar, Allahou Akbar, Allahou Akbar",translation:"Indeed, Safa and Marwa are sacred places ‚Ä¢ Allah is the Greatest (3x)"}},{id:5,title:"Taqsir or Halq",description:"Shortening or shaving hair",steps:["Men can shave or shorten","Women cut fingertip length","Marks end of Umrah","Ihram state ends"],dua:{arabic:"ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ÿßŸÑŸéŸëÿ∞ŸêŸä ŸÇŸéÿ∂ŸéŸâ ÿπŸéŸÜŸéŸëÿß ŸÜŸèÿ≥ŸèŸÉŸéŸÜŸéÿß",phonetic:"Al-·∏•amdu li-LlƒÅhi",translation:"Praise be to Allah"}}]};



function openPilgrimMaps(lat,lng,name){if(lat&&lng){const url=`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;window.open(url,'_blank')}else{alert('Position de '+name+' non disponible')}}

function openGoogleMaps(){if(S.guideLocation&&S.guideLocation.lat&&S.guideLocation.lng){const url=`https://www.google.com/maps/dir/?api=1&destination=${S.guideLocation.lat},${S.guideLocation.lng}`;window.open(url,'_blank')}else{alert('Position du guide non disponible')}}

let mediaRecorder=null;
let audioChunks=[];

function startRecording(){
  if(!S.currentGroup){alert('Cr√©ez un groupe d\'abord');return}
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert('Microphone non support√©');return}
  
  S.isRecording=true;R();
  navigator.mediaDevices.getUserMedia({audio:true})
    .then(stream=>{
      mediaRecorder=new MediaRecorder(stream);
      audioChunks=[];
      
      mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
      
      mediaRecorder.onstop=()=>{
        const audioBlob=new Blob(audioChunks,{type:'audio/webm'});
        const reader=new FileReader();
        reader.onloadend=()=>{
          const base64=reader.result;
          const msg={
            id:Date.now(),
            audio:base64,
            guideName:S.userName||'Guide',
            groupCode:S.currentGroup,
            timestamp:Date.now()
          };
          
          S.voiceMessages.unshift(msg);
          if(S.voiceMessages.length>10)S.voiceMessages=S.voiceMessages.slice(0,10);
          localStorage.setItem('voiceMessages_'+S.currentGroup,JSON.stringify(S.voiceMessages));
          
          // Envoyer √† Firebase
          syncVoiceToFirebase(msg);
          
          stream.getTracks().forEach(t=>t.stop());
          S.isRecording=false;R();
        };
        reader.readAsDataURL(audioBlob);
      };
      
      mediaRecorder.start();
    })
    .catch(err=>{alert('Erreur micro: '+err.message);S.isRecording=false;R()});
}

function stopRecording(){
  if(mediaRecorder&&mediaRecorder.state!=='inactive'){
    mediaRecorder.stop();
  }
}

function playVoiceMessage(msgId){
  const msg=S.voiceMessages.find(m=>m.id===msgId);
  if(!msg)return;
  const audio=new Audio(msg.audio);
  audio.play();
}

function loadVoiceMessages(){
  if(!S.currentGroup)return;
  const stored=localStorage.getItem('voiceMessages_'+S.currentGroup);
  if(stored){
    S.voiceMessages=JSON.parse(stored);
  }
  R();
}

function deleteVoiceMessage(msgId){
  S.voiceMessages=S.voiceMessages.filter(m=>m.id!==msgId);
  localStorage.setItem('voiceMessages_'+S.currentGroup,JSON.stringify(S.voiceMessages));
  R();
}


// D√©tecter connexion
window.addEventListener('online',()=>{S.isOnline=true;R();syncToFirebase()});
window.addEventListener('offline',()=>{S.isOnline=false;R()});

// Sync vers Firebase
function syncToFirebase(){if(!window.firebaseReady||!window.db){console.log("‚ö†Ô∏è Firebase pas pr√™t");return;}console.log("üîÑ Sync Firebase d√©marr√©");
  if(!S.isOnline||!S.currentGroup)return;
  
  // Sync groupes
  if(S.userType==='guide'){
    window.console.log('üìù Sauvegarde groupe:', S.currentGroup);window.db.ref('groups/'+S.currentGroup).set({
      guideName:S.userName,
      guideCode:S.guideCode,
      groupName:S.groupName,
      createdAt:Date.now()
    });
  }
  
  // Sync localStorage vers Firebase
  const pilgrims=localStorage.getItem('pilgrims');
  if(pilgrims){
    const allPilgrims=JSON.parse(pilgrims);
    const groupPilgrims=allPilgrims.filter(p=>p.groupCode===S.currentGroup);
    groupPilgrims.forEach(p=>{
      window.db.ref('pilgrims/'+S.currentGroup+'/'+p.code).set({
        name:p.name,
        photo:p.photo||'',
        hotel:p.hotel||'',
        room:p.room||'',
        completedSteps:p.completedSteps||{}
      });
    });
  }
}

// Charger depuis Firebase
function loadFromFirebase(){if(!window.firebaseReady||!window.db){console.log("‚ö†Ô∏è Firebase pas pr√™t pour load");return;}
  if(!S.isOnline||!S.currentGroup)return;
  
  // √âcouter les p√®lerins
  window.db.ref('pilgrims/'+S.currentGroup).on('value',snapshot=>{
    if(!snapshot.exists())return;
    
    const fbPilgrims=[];
    snapshot.forEach(child=>{
      const data=child.val();
      fbPilgrims.push({
        id:Date.now()+Math.random(),
        code:child.key,
        groupCode:S.currentGroup,
        name:data.name,
        photo:data.photo,
        hotel:data.hotel,
        room:data.room,
        completedSteps:data.completedSteps||{}
      });
    });
    
    // Mettre √† jour localStorage
    const stored=localStorage.getItem('pilgrims');
    let allPilgrims=stored?JSON.parse(stored):[];
    allPilgrims=allPilgrims.filter(p=>p.groupCode!==S.currentGroup);
    allPilgrims.push(...fbPilgrims);
    localStorage.setItem('pilgrims',JSON.stringify(allPilgrims));
    
    S.pilgrims=fbPilgrims;
    R();
  });
  
  S.fbListeners.push('pilgrims/'+S.currentGroup);
}

// Nettoyer listeners

// Sync messages vers Firebase
function syncMessagesToFirebase(){
  if(!S.isOnline||!S.currentGroup)return;
  S.messages.forEach(m=>{
    window.db.ref('messages/'+S.currentGroup+'/'+m.id).set({
      title:m.title,
      content:m.content,
      timestamp:m.time
    });
  });
}

// Charger messages depuis Firebase
function loadMessagesFromFirebase(){
  if(!S.isOnline||!S.currentGroup)return;
  window.db.ref('messages/'+S.currentGroup).on('value',snapshot=>{
    if(!snapshot.exists())return;
    const fbMessages=[];
    snapshot.forEach(child=>{
      const data=child.val();
      fbMessages.push({
        id:parseInt(child.key),
        title:data.title,
        content:data.content,
        time:data.timestamp
      });
    });
    S.messages=fbMessages.sort((a,b)=>b.time-a.time);
    localStorage.setItem('messages_'+S.currentGroup,JSON.stringify(S.messages));
    R();
  });
  S.fbListeners.push('messages/'+S.currentGroup);
}

// Sync questions vers Firebase
function syncQuestionsToFirebase(){
  if(!S.isOnline||!S.currentGroup)return;
  S.questions.forEach(q=>{
    window.db.ref('questions/'+S.currentGroup+'/'+q.id).set({
      pilgrimName:q.pilgrimName,
      question:q.question,
      answered:q.answered||false,
      response:q.response||'',
      timestamp:q.time
    });
  });
}

// Charger questions depuis Firebase
function loadQuestionsFromFirebase(){
  if(!S.isOnline||!S.currentGroup)return;
  window.db.ref('questions/'+S.currentGroup).on('value',snapshot=>{
    if(!snapshot.exists())return;
    const fbQuestions=[];
    snapshot.forEach(child=>{
      const data=child.val();
      fbQuestions.push({
        id:parseInt(child.key),
        pilgrimName:data.pilgrimName,
        question:data.question,
        answered:data.answered,
        response:data.response,
        time:data.timestamp
      });
    });
    S.questions=fbQuestions.sort((a,b)=>b.time-a.time);
    localStorage.setItem('questions_'+S.currentGroup,JSON.stringify(S.questions));
    R();
  });
  S.fbListeners.push('questions/'+S.currentGroup);
}


// Sync messages vocaux vers Firebase
function syncVoiceToFirebase(msg){
  if(!S.isOnline||!S.currentGroup)return;
  window.db.ref('voiceMessages/'+S.currentGroup+'/'+msg.id).set({
    audio:msg.audio,
    guideName:msg.guideName,
    timestamp:msg.timestamp
  });
}

// √âcouter messages vocaux Firebase
function listenVoiceMessages(){
  if(!S.isOnline||!S.currentGroup)return;
  window.db.ref('voiceMessages/'+S.currentGroup).limitToLast(10).on('child_added',snapshot=>{
    const data=snapshot.val();
    const msgId=parseInt(snapshot.key);
    
    // V√©rifier si on a d√©j√† ce message
    if(S.voiceMessages.find(m=>m.id===msgId))return;
    
    const msg={
      id:msgId,
      audio:data.audio,
      guideName:data.guideName,
      timestamp:data.timestamp
    };
    
    S.voiceMessages.unshift(msg);
    if(S.voiceMessages.length>10)S.voiceMessages=S.voiceMessages.slice(0,10);
    
    // Sauver aussi en localStorage
    localStorage.setItem('voiceMessages_'+S.currentGroup,JSON.stringify(S.voiceMessages));
    
    // Auto-play pour les p√®lerins
    if(S.userType==='pilgrim'&&data.timestamp>Date.now()-5000){
      playVoiceMessage(msgId);
    }
    
    R();
  });
  S.fbListeners.push('voiceMessages/'+S.currentGroup);
}

function cleanupFirebaseListeners(){
  S.fbListeners.forEach(path=>window.db.ref(path).off());
  S.fbListeners=[];
}

function selectLang(lang){S.lang=lang;localStorage.setItem('appLang',lang);S.showLangSelector=false;R()}
function showReconnect(){S.showReconnect=!S.showReconnect;R()}
function reconnectGuide(){const code=document.getElementById('guideCodeIn')?.value?.toUpperCase();if(!code)return alert('Entrez le code guide');const info=localStorage.getItem('guideGroup_'+code);if(!info)return alert('Code invalide');const data=JSON.parse(info);S.currentGroup=data.groupCode;S.groupCode=data.groupCode;S.groupName=data.groupName;S.guideCode=code;const pils=localStorage.getItem('pilgrims');if(pils)S.pilgrims=JSON.parse(pils).filter(p=>p.groupCode===data.groupCode);R()}
function respondActivity(actId,status){if(!S.activityResponses[actId])S.activityResponses[actId]={};S.activityResponses[actId][S.pilgrimCode]={name:S.userName,status:status,time:Date.now()};localStorage.setItem('activityResponses',JSON.stringify(S.activityResponses));R()}
function playAudio(rid){if(!S.audioState[rid])S.audioState[rid]={playing:false,loop:false,repeat:1,currentRepeat:0};const a=new Audio('https://download.quranicaudio.com/quran/abdur_rahmaan_as-sudays/001.mp3');window['audio'+rid]=a;a.onended=()=>{S.audioState[rid].currentRepeat++;if(S.audioState[rid].loop||S.audioState[rid].currentRepeat<S.audioState[rid].repeat){a.currentTime=0;a.play()}else{S.audioState[rid].playing=false;S.audioState[rid].currentRepeat=0}R()};a.play();S.audioState[rid].playing=true;R()}
function toggleAudio(rid){const a=window['audio'+rid];if(!a)return;if(S.audioState[rid].playing){a.pause();S.audioState[rid].playing=false}else{a.play();S.audioState[rid].playing=true}R()}
function toggleLoop(rid){S.audioState[rid].loop=!S.audioState[rid].loop;R()}
function setRepeat(rid,n){S.audioState[rid].repeat=parseInt(n)||1;R()}
function initDemo(){if(S.userType==='guide'&&S.currentGroup&&S.pilgrims.length===0){S.pilgrims=[{id:1,name:'Ahmed Ben Ali',hotel:'Hilton Makkah',room:'205',code:'ABC123',groupCode:S.currentGroup,photo:null,online:true,lat:21.4225,lng:39.8262,completedSteps:{1:true,2:true,3:false,4:false,5:false}},{id:2,name:'Fatima Zahra',hotel:'Hilton Makkah',room:'207',code:'DEF456',groupCode:S.currentGroup,photo:null,online:true,lat:21.4235,lng:39.8272,completedSteps:{1:true,2:true,3:true,4:true,5:false}},{id:3,name:'Mohammed Ibrahim',hotel:'Swissotel Makkah',room:'305',code:'GHI789',groupCode:S.currentGroup,photo:null,online:false,lat:21.4215,lng:39.8252,completedSteps:{1:true,2:false,3:false,4:false,5:false}},{id:4,name:'Khadija Nour',hotel:'Swissotel Makkah',room:'308',code:'JKL012',groupCode:S.currentGroup,photo:null,online:true,lat:21.4240,lng:39.8280,completedSteps:{1:true,2:true,3:true,4:true,5:true}}];localStorage.setItem('pilgrims',JSON.stringify(S.pilgrims));S.messages=[{id:1,title:'D√©part demain matin',content:'Rendez-vous √† 6h dans le lobby',time:new Date(Date.now()-3600000)}];S.activities=[{id:1,name:'Visite Mosqu√©e du Proph√®te',location:'M√©dine',time:'09:00',presence:{}},{id:2,name:'Tawaf de groupe',location:'Masjid al-Haram',time:'14:00',presence:{}}];S.questions=[{id:1,pilgrimName:'Ahmed Ben Ali',pilgrimId:1,question:'Je ne trouve pas mon groupe pour le Tawaf',time:new Date(Date.now()-1800000),answered:false,response:null}]}}
function fmtTime(d){const n=new Date(),diff=n-d,m=Math.floor(diff/60000),h=Math.floor(m/60),day=Math.floor(h/24);if(m<1)return "√† l'instant";if(m<60)return `il y a ${m} min`;if(h<24)return `il y a ${h}h`;return `il y a ${day}j`}
function calcProg(c){if(!c)return 0;const comp=Object.values(c).filter(v=>v).length;return Math.round((comp/5)*100)}
function getCnt(c){if(!c)return 0;return Object.values(c).filter(v=>v).length}
function calcDist(lat1,lng1,lat2,lng2){const R=6371000,dLat=(lat2-lat1)*Math.PI/180,dLng=(lng2-lng1)*Math.PI/180,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return Math.round(R*c)}
function getInit(n){return n.split(' ').map(x=>x[0]).join('').toUpperCase().substring(0,2)}
function selType(t){S.userType=t;R()}
function chLang(l){S.lang=l;R()}
function goBack(){S.userType=null;S.currentGroup=null;S.groupCode='';S.userName='';S.userPhoto=null;S.viewPilgrimProgress=null;S.viewQuestions=false;R()}
function createGrp(){const n=document.getElementById('groupNameIn')?.value;if(!n){alert('Veuillez entrer un nom pour le groupe');return}const existingPilgrims=localStorage.getItem('pilgrims');let c;if(!existingPilgrims||JSON.parse(existingPilgrims).length===0){c='DEMO01'}else{c=Math.random().toString(36).substring(2,8).toUpperCase()}const guideCode='G'+Math.random().toString(36).substring(2,9).toUpperCase();S.currentGroup=c;S.groupCode=c;S.groupName=n;S.guideCode=guideCode;localStorage.setItem('guideGroup_'+guideCode,JSON.stringify({groupCode:c,groupName:n,guideCode:guideCode,createdAt:Date.now()}));const storedPilgrims=localStorage.getItem('pilgrims');if(storedPilgrims){S.pilgrims=JSON.parse(storedPilgrims).filter(p=>p.groupCode===c)}initDemo();R()}
function joinGrp(){const c=document.getElementById('codeIn').value;if(c&&c.length>=6){const code=c.toUpperCase();const storedPilgrims=localStorage.getItem('pilgrims');if(storedPilgrims){S.pilgrims=JSON.parse(storedPilgrims)}const pilgrim=S.pilgrims.find(p=>p.code===code);if(pilgrim){S.userName=pilgrim.name;S.userHotel=pilgrim.hotel||'';S.userRoom=pilgrim.room||'';S.userPhoto=pilgrim.photo||null;S.pilgrimCode=code;S.currentGroup=pilgrim.groupCode;S.completedSteps=pilgrim.completedSteps||{1:false,2:false,3:false,4:false,5:false};S.pilgrimPresence={};S.activities=[{id:1,name:'Visite Mosqu√©e du Proph√®te',location:'M√©dine',time:'09:00'},{id:2,name:'Tawaf de groupe',location:'Masjid al-Haram',time:'14:00'}];R()}else{alert('Code invalide. Veuillez v√©rifier votre code.')}}}
function hdlPhoto(e){const f=e.target.files[0];if(f){const r=new FileReader();r.onload=x=>{S.userPhoto=x.target.result;if(S.userType==='pilgrim'&&S.pilgrimCode){const storedPilgrims=localStorage.getItem('pilgrims');if(storedPilgrims){S.pilgrims=JSON.parse(storedPilgrims)}const pilgrim=S.pilgrims.find(p=>p.code===S.pilgrimCode);if(pilgrim){pilgrim.photo=x.target.result;localStorage.setItem('pilgrims',JSON.stringify(S.pilgrims))}}R()};r.readAsDataURL(f)}}
function togRite(i){S.expandedRite=S.expandedRite===i?null:i;R()}
function compStp(i){if(S.userType==='pilgrim'){S.completedSteps[i]=!S.completedSteps[i];R()}}
function valPres(i){if(S.userType==='pilgrim'){S.pilgrimPresence[i]=true;R()}}
function shwAsk(){S.showAskQuestion=true;R()}
function hidAsk(){S.showAskQuestion=false;R()}
function askQ(){const q=document.getElementById('qTxt').value;if(q&&S.userType==='pilgrim'){S.questions=S.questions||[];S.questions.unshift({id:Date.now(),pilgrimName:S.userName,question:q,time:new Date(),answered:false,response:null});S.showAskQuestion=false;R()}}
function shwQs(){S.viewQuestions=true;R()}
function hidQs(){S.viewQuestions=false;R()}
function ansQ(i){const r=document.getElementById(`rsp-${i}`).value;if(r){const q=S.questions.find(x=>x.id===i);if(q){q.answered=true;q.response=r;R()}}}
function incTaw(){if(S.tawafCount<7){S.tawafCount++;if(S.tawafCount===7&&S.userType==='pilgrim'){S.completedSteps[2]=true}R()}}
function rstTaw(){S.tawafCount=0;if(S.userType==='pilgrim'){S.completedSteps[2]=false}R()}
function incSai(){if(S.saiCount<7){S.saiCount++;if(S.saiCount===7&&S.userType==='pilgrim'){S.completedSteps[4]=true}R()}}
function rstSai(){S.saiCount=0;if(S.userType==='pilgrim'){S.completedSteps[4]=false}R()}
function shwMsg(){S.showAddMessage=true;R()}
function hidMsg(){S.showAddMessage=false;R()}
function sndMsg(){const t=document.getElementById('msgT').value,c=document.getElementById('msgC').value;if(t&&c){S.messages.unshift({id:Date.now(),title:t,content:c,time:new Date()});S.showAddMessage=false;R()}}
function delMsg(i){S.messages=S.messages.filter(m=>m.id!==i);R()}
function shwPil(){S.showAddPilgrim=true;R()}
function hidPil(){S.showAddPilgrim=false;R()}
function shwEditPil(id){S.editPilgrimId=id;S.showEditPilgrim=true;R()}
function hidEditPil(){S.showEditPilgrim=false;S.editPilgrimId=null;R()}
function updatePil(){const h=document.getElementById('editH').value,r=document.getElementById('editR').value;if(S.editPilgrimId){const storedPilgrims=localStorage.getItem('pilgrims');if(storedPilgrims){S.pilgrims=JSON.parse(storedPilgrims)}const pilgrim=S.pilgrims.find(p=>p.id===S.editPilgrimId);if(pilgrim){pilgrim.hotel=h||'';pilgrim.room=r||'';localStorage.setItem('pilgrims',JSON.stringify(S.pilgrims))}S.showEditPilgrim=false;S.editPilgrimId=null;R()}}
function sendWhatsApp(pilgrim){const msg=`üïã *${S.groupName}*%0A%0ASalam ${pilgrim.name},%0A%0AVotre code personnel pour l'application Oumrah :%0A*${pilgrim.code}*%0A%0AH√¥tel: ${pilgrim.hotel||'√Ä confirmer'}%0AChambre: ${pilgrim.room||'√Ä confirmer'}%0A%0AUtilisez ce code pour vous connecter √† l'application.%0A%0AQu'Allah accepte votre Oumrah ! ü§≤`;window.open(`https://wa.me/?text=${msg}`,'_blank')}
function savPil(){const n=document.getElementById('pilN').value,h=document.getElementById('pilH').value,r=document.getElementById('pilR').value;if(n){const code=Math.random().toString(36).substring(2,8).toUpperCase();S.pilgrims.push({id:Date.now(),name:n,hotel:h||'',room:r||'',code:code,groupCode:S.currentGroup,photo:null,online:false,lat:21.4225+Math.random()*0.01,lng:39.8262+Math.random()*0.01,completedSteps:{1:false,2:false,3:false,4:false,5:false}});localStorage.setItem('pilgrims',JSON.stringify(S.pilgrims));S.showAddPilgrim=false;R()}}
function delPil(i){S.pilgrims=S.pilgrims.filter(p=>p.id!==i);R()}
function shwAct(){S.showAddActivity=true;R()}
function hidAct(){S.showAddActivity=false;R()}
function savAct(){const n=document.getElementById('actN').value,l=document.getElementById('actL').value,d=document.getElementById('actD').value,t=document.getElementById('actT').value;if(n&&l&&d&&t){S.activities.push({id:Date.now(),name:n,location:l,date:d,time:t,presence:{}});S.showAddActivity=false;R()}}
function delAct(i){S.activities=S.activities.filter(a=>a.id!==i);R()}
function togPres(a,p){const act=S.activities.find(x=>x.id===a);if(act){if(!act.presence)act.presence={};act.presence[p]=!act.presence[p];R()}}
function viewProg(i){S.viewPilgrimProgress=i;R()}
function closeProg(){S.viewPilgrimProgress=null;R()}

function rActResponses(t){const storedResponses=JSON.parse(localStorage.getItem('activityResponses')||'{}');return `<h2 style="margin-bottom:20px">R√©ponses Activit√©s</h2>${S.activities.length===0?`<p style="text-align:center;color:#6b7280;padding:40px 0">Aucune activit√©</p>`:S.activities.map(a=>{const responses=storedResponses[a.id]||{};const validated=Object.values(responses).filter(r=>r.status==='validated').length;const cancelled=Object.values(responses).filter(r=>r.status==='cancelled').length;const pending=S.pilgrims.length-validated-cancelled;return `<div class="activity-item"><h3>${a.name}</h3><p>üìç ${a.location}</p><p style="margin:5px 0">üìÖ ${a.date||"Date non d√©finie"} ‚Ä¢ üïê ${a.time}</p><div style="display:flex;gap:10px;margin:10px 0"><span class="badge badge-success">${validated} ‚úì Valid√©s</span><span class="badge badge-absent">${cancelled} ‚úó Annul√©s</span><span class="badge badge-warning">${pending} En attente</span></div><div style="margin-top:10px">${Object.entries(responses).map(([code,resp])=>{const pilgrim=S.pilgrims.find(p=>p.code===code);return `<div style="padding:8px;background:white;border-radius:8px;margin:5px 0;display:flex;justify-content:space-between;align-items:center"><span>${resp.name}</span><span class="badge ${resp.status==='validated'?'badge-success':'badge-absent'}">${resp.status==='validated'?'‚úì Valid√©':'‚úó Annul√©'}</span></div>`}).join('')}</div></div>`}).join('')}`}

function R(){const app=document.getElementById('app'),L=S.lang,tr=T[L];if(S.showLangSelector){app.innerHTML=`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000"><div style="background:white;padding:60px 40px;border-radius:30px;max-width:600px;width:90%;text-align:center"><h1 style="color:#047857;margin-bottom:40px;font-size:32px">üïã</h1><h2 style="color:#059669;margin-bottom:40px">Choisissez votre langue<br>Select your language</h2><div style="display:flex;gap:20px;justify-content:center"><button onclick="selectLang('fr')" style="flex:1;padding:30px 20px;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);color:white;border:none;border-radius:15px;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(5,150,105,0.3)"><div style="font-size:48px">üá´üá∑</div><div>Fran√ßais</div></button><button onclick="selectLang('en')" style="flex:1;padding:30px 20px;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);color:white;border:none;border-radius:15px;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(5,150,105,0.3)"><div style="font-size:48px">üá¨üáß</div><div>English</div></button></div></div></div>`;return}if(!S.userType){app.innerHTML=rSelType(tr)}else if(!S.currentGroup){app.innerHTML=rJoin(tr)}else if(S.viewPilgrimProgress){app.innerHTML=rProgView(tr,L)}else if(S.viewQuestions){app.innerHTML=rQView(tr)}else{app.innerHTML=rMain(tr,L)}}
function rSelType(t){return `<div class="container"><div class="card"><div class="icon-circle"><svg width="32" height="32" fill="white" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div><h1>${t.appTitle}</h1><p style="text-align:center;margin-bottom:30px">${t.userType}</p><button class="btn-primary" onclick="selType('guide')">${t.guide}</button><button class="btn-secondary" onclick="selType('pilgrim')">${t.pilgrims}</button><div style="text-align:center;margin-top:20px"><select onchange="chLang(this.value)" style="width:auto;display:inline-block"><option value="fr" ${S.lang==='fr'?'selected':''}>Fran√ßais</option><option value="en" ${S.lang==='en'?'selected':''}>English</option></select></div></div></div>`}
function rJoin(t){return `<div class="container"><div class="card"><button class="btn-secondary" onclick="goBack()" style="margin-bottom:20px">${t.back}</button><h2>${S.userType==='guide'?t.create:t.join}</h2>${S.userType==='guide'?`${S.showReconnect?`<input type="text" id="guideCodeIn" placeholder="Code guide (G...)" style="text-transform:uppercase;margin:15px 0"><button class="btn-primary" onclick="reconnectGuide()">Se reconnecter</button><button class="btn-secondary" onclick="showReconnect()">Annuler</button>`:`<input type="text" id="groupNameIn" placeholder="${t.enterGroupName}" style="margin:15px 0"><button class="btn-primary" onclick="createGrp()">Cr√©er nouveau groupe</button><button class="btn-secondary" onclick="showReconnect()">Se reconnecter</button>`}`:`<p style="text-align:center;margin-bottom:20px;color:#6b7280">Entrez le code personnel fourni par votre guide</p><input type="text" id="codeIn" placeholder="${t.enterCode}" maxlength="6" style="text-transform:uppercase;text-align:center;font-size:24px;font-weight:bold"><button class="btn-primary" onclick="joinGrp()">${t.join}</button>`}</div></div>`}
function rQView(t){const un=S.questions.filter(q=>!q.answered).length;return `<div class="container"><div class="card"><button class="btn-secondary" onclick="hidQs()" style="margin-bottom:20px">${t.back}</button><h2>${t.pilgrimsQuestions} ${un>0?`<span class="badge badge-warning">${un}</span>`:''}</h2>${S.questions.length===0?`<p style="text-align:center;color:#6b7280;padding:40px 0">${t.noQuestions}</p>`:S.questions.map(q=>`<div class="question-item"><div class="flex-between" style="margin-bottom:10px"><h3 style="margin:0">${q.pilgrimName}</h3>${q.answered?'<span class="badge badge-success">'+t.answered+'</span>':'<span class="badge badge-warning">'+t.awaitingResponse+'</span>'}</div><p style="margin:10px 0;padding:10px;background:white;border-radius:8px">${q.question}</p><p class="message-time">${fmtTime(q.time)}</p>${q.answered?`<div class="question-response"><strong>${t.response}:</strong> ${q.response}</div>`:`<div style="margin-top:15px"><textarea id="rsp-${q.id}" placeholder="${t.response}..." style="margin-bottom:10px"></textarea><button class="btn-primary btn-small" onclick="ansQ(${q.id})">${t.answer}</button></div>`}</div>`).join('')}</div></div>`}
function rProgView(t,L){const p=S.pilgrims.find(x=>x.id===S.viewPilgrimProgress);if(!p)return '';const rts=RITES[L],prog=calcProg(p.completedSteps),cnt=getCnt(p.completedSteps);return `<div class="container"><div class="card"><button class="btn-secondary" onclick="closeProg()" style="margin-bottom:20px">${t.back}</button><h2>${t.pilgrimProgress}</h2><h3 style="text-align:center;color:#059669;margin-bottom:20px">${p.name}</h3><div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div><p class="progress-text">${cnt} ${t.of} 5 ${t.stepsCompleted} (${prog}%)</p><div style="margin-top:30px">${rts.map((r,i)=>{const done=p.completedSteps&&p.completedSteps[r.id];return `<div class="rite-item ${done?'completed':''}"><div class="rite-header"><div style="display:flex;align-items:center;flex:1"><div class="rite-number ${done?'completed':''}">${['üïå','üïã','üôè','üö∂','‚úÇÔ∏è'][i]} ${i+1}</div><div style="flex:1"><h3 style="margin:0">${r.title}</h3><p style="margin:5px 0 0 0;font-size:14px;color:${done?'#059669':'#6b7280'}">${done?t.completed:t.notStarted}</p></div></div>${done?'<span class="checkmark">‚úì</span>':''}</div></div>`}).join('')}</div></div></div>`}
function rMain(t,L){const rts=RITES[L];if(S.userType==='pilgrim'&&S.pilgrimCode){const storedPilgrims=localStorage.getItem('pilgrims');if(storedPilgrims){const allPilgrims=JSON.parse(storedPilgrims);const currentPilgrim=allPilgrims.find(p=>p.code===S.pilgrimCode);if(currentPilgrim){S.userHotel=currentPilgrim.hotel||'';S.userRoom=currentPilgrim.room||'';S.userPhoto=currentPilgrim.photo||null}}}let hdr=''; let tabs='';if(S.userType==='guide'){tabs=`<button class="tab ${S.activeTab==='rites'?'active':''}" onclick="S.activeTab='rites';R()"><span class="tab-icon">üïã</span><span>${t.rites}</span></button><button class="tab ${S.activeTab==='group'?'active':''}" onclick="S.activeTab='group';R()"><span class="tab-icon">üë•</span><span>Groupe</span></button><button class="tab ${S.activeTab==='presence'?'active':''}" onclick="S.activeTab='presence';R()"><span class="tab-icon">üìç</span><span>Pr√©sence</span></button><button class="tab ${S.activeTab==='messages'?'active':''}" onclick="S.activeTab='messages';R()"><span class="tab-icon">üí¨</span><span>Messages</span></button><button class="tab ${S.activeTab==='profile'?'active':''}" onclick="S.activeTab='profile';R()"><span class="tab-icon">üë§</span><span>Profil</span></button>`}else{tabs=`<button class="tab ${S.activeTab==='rites'?'active':''}" onclick="S.activeTab='rites';R()"><span class="tab-icon">üïã</span><span>${t.rites}</span></button><button class="tab ${S.activeTab==='voice'?'active':''}" onclick="S.activeTab='voice';loadVoiceMessages();R()"><span class="tab-icon">üéôÔ∏è</span><span>Messages</span></button><button class="tab ${S.activeTab==='activities'?'active':''}" onclick="S.activeTab='activities';R()"><span class="tab-icon">‚úÖ</span><span>Activit√©s</span></button><button class="tab ${S.activeTab==='questions'?'active':''}" onclick="S.activeTab='questions';R()"><span class="tab-icon">üí¨</span><span>Questions</span></button><button class="tab ${S.activeTab==='profile'?'active':''}" onclick="S.activeTab='profile';R()"><span class="tab-icon">üë§</span><span>Profil</span></button>`}return `<div class="tab-bar">${tabs}</div><div class="container">${rTab(t,L,rts)}</div>`}
function rTab(t,L,rts){switch(S.activeTab){case 'rites':return rRites(t,rts);case 'detailed':return rDetailed(t,L);case 'group':return rGroup(t);case 'activities':return rMyActs(t);case 'questions':return rMyQs(t);case 'messages':return rMsgs(t);case 'presence':return rPresence(t);case 'voice':return rVoiceMessages(t);case 'profile':return rProfile(t);default:return ''}}


function rVoiceMessages(t){return `<h2 style="margin-bottom:20px">üéôÔ∏è Messages du Guide</h2>${S.voiceMessages.length===0?`<div class="card" style="text-align:center;padding:60px 20px;background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%)"><div style="font-size:64px;margin-bottom:20px;opacity:0.5">üéôÔ∏è</div><p style="color:#6b7280;font-size:16px;margin:0">Aucun message vocal</p><p style="color:#9ca3af;font-size:14px;margin:10px 0 0 0">Les messages du guide appara√Ætront ici</p></div>`:S.voiceMessages.map(m=>{const date=new Date(m.timestamp);const timeStr=date.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});return `<div class="voice-message-card"><div class="voice-message-header"><div style="display:flex;align-items:center;gap:12px;flex:1"><div class="voice-avatar">${getInit(m.guideName)}</div><div><h3 style="margin:0 0 3px 0;font-size:16px;color:#047857">${m.guideName}</h3><p style="margin:0;font-size:13px;color:#6b7280">üïê ${timeStr}</p></div></div>${S.userType==='guide'?`<button onclick="deleteVoiceMessage(${m.id})" class="voice-delete-btn">üóëÔ∏è</button>`:''}</div><button onclick="playVoiceMessage(${m.id})" class="voice-play-btn"><span style="font-size:24px">‚ñ∂</span><span>√âcouter le message</span></button></div>`}).join('')}`}

function rProfile(t){if(S.userType==='guide'){const unQ=S.questions.filter(q=>!q.answered).length;return `<div class="card" style="text-align:center"><div style="width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:48px;margin:0 auto 20px auto">${getInit(S.userName||'Guide')}</div><h2 style="margin:10px 0">${S.userName||'Guide'}</h2><div style="background:#f0fdf4;padding:20px;border-radius:15px;margin:20px 0"><p style="margin:10px 0;color:#047857;font-weight:600">üìã Groupe: ${S.groupName}</p><p style="margin:10px 0;color:#047857;font-weight:600">üîë Code groupe: ${S.currentGroup}</p><p style="margin:10px 0;color:#059669;font-weight:600;font-size:18px">üîê Code guide: ${S.guideCode||'...'}</p><p style="margin:5px 0;font-size:12px;color:#6b7280">Conservez ce code pour vous reconnecter</p><p style="margin:10px 0;color:#047857;font-weight:600">üë• P√®lerins: ${S.pilgrims.length}</p>${unQ>0?`<p style="margin:10px 0;color:#f59e0b;font-weight:600">‚ùì Questions en attente: ${unQ}</p>`:''}</div><button class="btn-secondary" onclick="goBack()" style="width:100%">üö™ Se d√©connecter</button></div>`}else{const prog=calcProg(S.completedSteps),cnt=getCnt(S.completedSteps),init=getInit(S.userName);return `<div class="card" style="text-align:center"><div style="width:120px;height:120px;border-radius:50%;overflow:hidden;margin:0 auto 20px auto;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);display:flex;align-items:center;justify-content:center">${S.userPhoto?`<img src="${S.userPhoto}" style="width:100%;height:100%;object-fit:cover">`:`<div style="color:white;font-weight:bold;font-size:48px">${init}</div>`}</div><label for="photoUploadProfile" class="btn-secondary btn-small" style="cursor:pointer;display:inline-block;margin-bottom:20px">üì∏ ${S.userPhoto?'Changer':'Ajouter'} photo</label><input type="file" id="photoUploadProfile" accept="image/*" onchange="hdlPhoto(event)" style="display:none"><h2 style="margin:10px 0">${S.userName}</h2><div style="background:#f0fdf4;padding:20px;border-radius:15px;margin:20px 0"><p style="margin:10px 0;color:#047857;font-weight:600">üîë Code: ${S.pilgrimCode}</p>${S.userHotel||S.userRoom?`<p style="margin:10px 0;color:#047857;font-weight:600">üè® ${S.userHotel||'H√¥tel'} ${S.userRoom?`‚Ä¢ üö™ Chambre ${S.userRoom}`:''}</p>`:''}<h3 style="color:#059669;margin:20px 0 10px 0">Progression Oumrah</h3><div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div><p style="font-size:16px;font-weight:600;color:#059669;margin:10px 0">${cnt} / 5 ${t.stepsCompleted} (${prog}%)</p></div><button class="btn-secondary" onclick="goBack()" style="width:100%">üö™ Se d√©connecter</button></div>`}}
function rGroup(t){const storedPilgrims=localStorage.getItem('pilgrims');if(storedPilgrims&&S.userType==='guide'){const allPilgrims=JSON.parse(storedPilgrims);S.pilgrims=allPilgrims.filter(p=>p.groupCode===S.currentGroup)}return `<div class="flex-between" style="margin-bottom:20px"><h2 style="margin:0">üë• Gestion Groupe</h2><button class="btn-primary btn-small" onclick="shwPil()">+ ${t.addPilgrim}</button></div>${S.showAddPilgrim?`<div class="card" style="background:#f0fdf4"><h3>${t.addPilgrim}</h3><input type="text" id="pilN" placeholder="${t.pilgrimName}"><input type="text" id="pilH" placeholder="Nom de l'h√¥tel"><input type="text" id="pilR" placeholder="${t.roomNumber}"><div class="flex-row"><button class="btn-primary" onclick="savPil()">${t.save}</button><button class="btn-secondary" onclick="hidPil()">${t.cancel}</button></div></div>`:''}${S.showEditPilgrim?`<div class="card" style="background:#fff3cd;border:2px solid #f59e0b"><h3>‚úèÔ∏è Modifier l'h√¥tel et la chambre</h3><input type="text" id="editH" placeholder="Nom de l'h√¥tel" value="${S.pilgrims.find(p=>p.id===S.editPilgrimId)?.hotel||''}"><input type="text" id="editR" placeholder="${t.roomNumber}" value="${S.pilgrims.find(p=>p.id===S.editPilgrimId)?.room||''}"><div class="flex-row"><button class="btn-primary" onclick="updatePil()">${t.save}</button><button class="btn-secondary" onclick="hidEditPil()">${t.cancel}</button></div></div>`:''}${S.pilgrims.length===0?`<p style="text-align:center;color:#6b7280;padding:40px 0">${t.noPilgrims}</p>`:S.pilgrims.map(p=>{const init=getInit(p.name);const prog=calcProg(p.completedSteps),cnt=getCnt(p.completedSteps);return `<div class="pilgrim-item"><div style="display:flex;align-items:start;gap:15px;margin-bottom:15px"><div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:20px;overflow:hidden;flex-shrink:0">${p.photo?`<img src="${p.photo}" style="width:100%;height:100%;object-fit:cover" alt="${p.name}">`:init}</div><div style="flex:1"><h3 style="margin:0 0 5px 0">${p.name}</h3><div style="display:flex;gap:8px;flex-wrap:wrap;margin:5px 0">${p.hotel?`<span class="badge badge-info">üè® ${p.hotel}</span>`:''}<span class="badge badge-info">üö™ ${p.room||'N/A'}</span><span class="badge badge-warning" style="font-family:monospace;font-size:12px">${p.code}</span></div><div class="progress-bar" style="margin:10px 0"><div class="progress-fill" style="width:${prog}%"></div></div><p style="font-size:13px;color:#059669;font-weight:600;margin:0">${cnt}/5 ${t.stepsCompleted} (${prog}%)</p></div><div style="display:flex;flex-direction:column;gap:5px"><button class="btn-success btn-small" onclick="openPilgrimMaps(${p.lat||S.guideLocation.lat+0.001},${p.lng||S.guideLocation.lng+0.001},'${p.name}')" title="Localiser">üó∫Ô∏è</button><button class="btn-warning btn-small" onclick="shwEditPil(${p.id})" title="Modifier">‚úèÔ∏è</button><button class="btn-primary btn-small" onclick="viewProg(${p.id})" title="Progression">üìä</button><button class="btn-danger btn-small" onclick="delPil(${p.id})" title="Supprimer">üóëÔ∏è</button></div></div><button class="btn-success btn-small" onclick='sendWhatsApp(${JSON.stringify(p).replace(/'/g,"\\'")})' style="width:100%;background:#25D366;border-color:#25D366">üì± ${t.sendWhatsApp}</button></div>`}).join('')}`}

function rRites(t,rts){const isP=S.userType==='pilgrim';return `<h2 style="margin-bottom:20px">${t.rites}</h2>${rts.map((r,i)=>{const done=isP&&S.completedSteps&&S.completedSteps[r.id];return `<div class="rite-item ${done?'completed':''}"><div class="rite-header" onclick="togRite(${r.id})"><div style="display:flex;align-items:center;flex:1"><div class="rite-number ${done?'completed':''}">${['üïå','üïã','üôè','üö∂','‚úÇÔ∏è'][i]} ${i+1}</div><div style="flex:1"><h3 style="margin:0">${r.title}</h3><p style="margin:5px 0 0 0;font-size:14px">${r.description}</p>${isP?`<p style="margin:5px 0 0 0;font-size:13px;font-weight:600;color:${done?'#10b981':'#6b7280'}">${done?t.completed:t.notStarted}</p>`:''}</div></div><div style="font-size:24px;color:#059669">${S.expandedRite===r.id?'‚àí':'+'}</div></div>${S.expandedRite===r.id?`<div class="rite-content"><h3>${t.steps}</h3><ol>${r.steps.map(s=>`<li>${s}</li>`).join('')}</ol><h3 style="margin-top:20px">${t.invocation}</h3><div class="dua-box"><div class="arabic-text">${r.dua.arabic}</div></div><div class="dua-box"><span class="label">${t.phonetic}</span><div class="phonetic-text">${r.dua.phonetic}</div></div><div class="dua-box"><span class="label">${t.translation}</span><div class="translation-text">${r.dua.translation}</div></div>${isP?`<div class="audio-player" style="margin:20px 0;border:3px solid #3b82f6"><div class="audio-text">${r.dua.arabic}</div><div class="audio-controls"><button class="audio-btn" onclick="toggleLoop(${r.id})">üîÅ</button>${S.audioState[r.id]?.playing?`<button class="audio-btn" onclick="toggleAudio(${r.id})">‚è∏</button>`:`<button class="audio-btn" onclick="playAudio(${r.id})">‚ñ∂</button>`}<button class="audio-btn" style="font-size:14px">1.0x</button></div><div class="audio-progress"><div class="audio-progress-fill"></div></div></div>`:''}${isP&&r.id!==2&&r.id!==4?`<div style="margin-top:20px"><button class="${done?'btn-completed':'btn-success'}" onclick="compStp(${r.id})">${done?t.completed:t.markComplete}</button></div>`:''}${r.id===2?`<div style="margin-top:20px;background:white;padding:20px;border-radius:15px;border:2px solid #059669"><h3 style="text-align:center">${t.counter}</h3><div class="counter-circle"><div class="counter-number">${S.tawafCount}</div></div><p style="text-align:center;font-weight:600;margin-bottom:15px">${t.round} ${S.tawafCount}/7</p>${S.tawafCount<7?`<button class="btn-primary" onclick="incTaw()">+ 1 ${t.round}</button>`:`<div class="success-box"><div class="success-text">${t.tawafComplete}</div></div><button class="btn-reset" onclick="rstTaw()">${t.reset}</button>`}</div>`:''}${r.id===4?`<div style="margin-top:20px;background:white;padding:20px;border-radius:15px;border:2px solid #059669"><h3 style="text-align:center">${t.counter}</h3><div class="counter-circle"><div class="counter-number">${S.saiCount}</div></div><p style="text-align:center;font-weight:600;margin-bottom:15px">${t.trip} ${S.saiCount}/7</p>${S.saiCount<7?`<button class="btn-primary" onclick="incSai()">+ 1 ${t.trip}</button>`:`<div class="success-box"><div class="success-text">${t.saiComplete}</div></div><button class="btn-reset" onclick="rstSai()">${t.reset}</button>`}</div>`:''}</div>`:''}</div>`}).join('')}`}
function rDetailed(t,L){return `<h2 style="margin-bottom:20px">üìñ Guide Complet de la Oumra</h2><div class="card" style="background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);border:2px solid #059669"><h3 style="color:#047857">üéØ But de l'Ihram</h3><div style="display:flex;align-items:start;gap:10px;margin:10px 0"><span style="color:#059669;font-size:20px">‚úì</span><p style="margin:0"><strong>Montrer sa soumission totale √† Allah</strong> - Se mettre enti√®rement dans un √©tat d'adoration</p></div><div style="display:flex;align-items:start;gap:10px;margin:10px 0"><span style="color:#059669;font-size:20px">‚úì</span><p style="margin:0"><strong>Se d√©tacher des besoins et d√©sirs mondains</strong> pour se concentrer sur le rituel</p></div><div style="display:flex;align-items:start;gap:10px;margin:10px 0"><span style="color:#059669;font-size:20px">‚úì</span><p style="margin:0"><strong>Entrer dans un √©tat de puret√© spirituelle et morale</strong></p></div></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">üìç √âtape 1 : Faire le Ghusl (Purification)</h3><p>Se laver compl√®tement le corps avant d'entrer en √©tat d'Ihram</p></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">üëï √âtape 2 : Porter l'Ihram</h3><p><strong>Hommes :</strong> 2 pi√®ces de tissu blanc non cousu</p><p><strong>Femmes :</strong> V√™tements modestes (pas de tenue obligatoire sp√©cifique)</p></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">ü§≤ √âtape 3 : Formuler l'intention (Niyyah)</h3><div class="dua-box" style="margin-top:15px"><h4 style="color:#059669;margin-bottom:10px">Pour soi-m√™me :</h4><div class="arabic-text">ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸé ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿπŸèŸÖŸíÿ±Ÿéÿ©Ÿã</div><p class="phonetic-text" style="margin:10px 0">Labbayka AllƒÅhoumma 'Umratan</p><p class="translation-text">Je r√©ponds √† ton appel, √î Allah par une Oumra</p></div><div class="dua-box" style="margin-top:15px"><h4 style="color:#059669;margin-bottom:10px">Pour une autre personne :</h4><div class="arabic-text">ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸé ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿπŸèŸÖŸíÿ±Ÿéÿ©Ÿã ÿπŸéŸÜŸí [ŸÅŸèŸÑŸéÿßŸÜŸê ÿ®ŸíŸÜŸê ŸÅŸèŸÑŸéÿßŸÜŸç]</div><p class="phonetic-text" style="margin:10px 0">Labbayka Allahoumma 'umrah 'an [Foulan ibn foulan]</p><p class="translation-text">Me voici, √î Allah, pour la Omra pour [nom de la personne fils d'un tel]</p></div></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">üïå √âtape 4 : Se rendre √† Masjid Al-Haram</h3><p>R√©citer fr√©quemment la Talbiya en chemin</p><div class="dua-box" style="margin-top:10px"><div class="arabic-text">ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸé ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ŸÑŸéÿ®ŸéŸëŸäŸíŸÉŸé</div><p class="phonetic-text" style="margin:10px 0">Labbayka AllƒÅhoumma labbayk</p></div></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">üïã √âtape 5 : Tawaf - 7 tours autour de la Ka'ba</h3><p>Commencer au niveau de la Pierre Noire, faire 7 tours dans le sens antihoraire</p></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">üôè √âtape 6 : Pri√®re de 2 Rak'at derri√®re Maqam Ibrahim</h3><p>Accomplir 2 unit√©s de pri√®re apr√®s le Tawaf</p></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">üíß √âtape 7 : Boire l'eau de Zamzam</h3><p>Boire de l'eau de Zamzam et faire des invocations</p><div class="dua-box" style="margin-top:10px;background:#e0f2fe"><p style="color:#0369a1;margin:0">üí° <strong>Conseil :</strong> Boire en √©tant debout, face √† la Ka'ba, en invoquant Allah pour ce que vous d√©sirez</p></div></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">üèÉ √âtape 8 : Sa'i - 7 allers-retours entre Safa et Marwa</h3><p>Commencer √† Safa, marcher jusqu'√† Marwa et r√©p√©ter 7 fois</p></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">‚úÇÔ∏è √âtape 9 : Se raser ou raccourcir les cheveux</h3><p><strong>Hommes :</strong> Raser (Halq) ou raccourcir (Taqsir)</p><p><strong>Femmes :</strong> Couper l'√©quivalent d'une phalange</p></div><div class="card" style="background:#fff;border:2px solid #d1fae5"><h3 style="color:#047857">üéä √âtape 10 : Sortir de l'√©tat d'Ihram</h3><p style="color:#059669;font-weight:600;font-size:18px">‚ú® F√©licitations ! Votre Oumra est termin√©e ‚ú®</p><p>Vous pouvez maintenant reprendre vos activit√©s normales</p></div><div class="success-box" style="margin-top:20px"><div class="success-text">ü§≤ Qu'Allah accepte votre Oumra</div></div>`}
function rGuideLoc(t){const pLat=21.4230,pLng=39.8268,dist=calcDist(pLat,pLng,S.guideLocation.lat,S.guideLocation.lng);return `<h2 style="margin-bottom:20px">${t.guideLocation}</h2><div class="guide-location-card"><h3 style="text-align:center;color:#1e40af;margin-bottom:15px">${t.guideDistance}</h3><div class="distance-display">${dist} ${t.meters}</div><div class="map-placeholder" style="margin-top:20px"><div style="text-align:center;z-index:10"><svg width="48" height="48" fill="#047857" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg><p style="color:#047857;font-weight:600;margin-top:10px">${t.findGuide}</p></div><div style="position:absolute;left:50%;top:50%;width:40px;height:40px;background:#3b82f6;border-radius:50%;border:4px solid white;box-shadow:0 4px 10px rgba(0,0,0,0.3);transform:translate(-50%,-50%)"></div><div style="position:absolute;left:60%;top:40%;width:30px;height:30px;background:#059669;border-radius:50%;border:3px solid white;box-shadow:0 4px 10px rgba(0,0,0,0.2)"></div></div><p style="text-align:center;margin-top:15px;font-size:13px;color:#1e40af">üìç Position mise √† jour en temps r√©el</p></div><div class="card" style="margin-top:20px;background:#fef3c7;border:2px solid #f59e0b"><h3 style="color:#92400e">üí° Conseil</h3><p style="color:#78350f;margin:0">Gardez cette page ouverte pour suivre le guide en temps r√©el.</p></div>`}
function rMyActs(t){return `<h2 style="margin-bottom:20px">‚úÖ Mes Activit√©s</h2>${S.activities.length===0?`<p style="text-align:center;color:#6b7280;padding:40px 0">${t.noActivities}</p>`:S.activities.map(a=>{const resp=S.activityResponses[a.id]?.[S.pilgrimCode];const status=resp?resp.status:'pending';return `<div class="activity-item"><div style="margin-bottom:15px"><h3 style="margin:0 0 5px 0">${a.name}</h3><p style="margin:0;font-size:14px;color:#6b7280">üìç ${a.location}</p><p style="margin:5px 0 0 0;font-size:14px;color:#6b7280">üìÖ ${a.date||"Date non d√©finie"} ‚Ä¢ üïê ${a.time}</p></div>${status==='pending'?`<div style="display:flex;gap:10px"><button class="btn-success" onclick="respondActivity(${a.id},'validated')" style="flex:1">‚úì Valider pr√©sence</button><button class="btn-danger" onclick="respondActivity(${a.id},'cancelled')" style="flex:1">‚úó Annuler pr√©sence</button></div>`:status==='validated'?`<span class="badge badge-success" style="padding:10px">‚úì Pr√©sence valid√©e</span>`:`<span class="badge badge-absent" style="padding:10px">‚úó Pr√©sence annul√©e</span>`}</div>`}).join('')}`}
function rMyQs(t){const myQ=S.questions.filter(q=>q.pilgrimName===S.userName);return `<h2 style="margin-bottom:20px">üí¨ Questions & Localisation</h2><div class="card" style="background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);border:2px solid #059669;margin-bottom:30px"><h3 style="color:#047857;margin:0 0 15px 0">üó∫Ô∏è Localisation du Guide</h3><div style="position:relative"><button onclick="openGoogleMaps()" style="width:100%;background:#059669;color:white;border:none;padding:15px;border-radius:10px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 4px 15px rgba(5,150,105,0.3)"><span style="font-size:24px">üó∫Ô∏è</span><span>Ouvrir l'itin√©raire dans Google Maps</span></button></div><p style="text-align:center;margin:15px 0 5px 0;color:#047857;font-size:14px">Distance estim√©e: ~${Math.floor(Math.random()*500)+100}m</p></div><div class="flex-between" style="margin-bottom:20px"><h3 style="margin:0">‚ùì Vos Questions</h3><button class="btn-primary btn-small" onclick="shwAsk()">+ ${t.askQuestion}</button></div>${S.showAskQuestion?`<div class="card" style="background:#f0fdf4"><h3>${t.askQuestion}</h3><textarea id="qTxt" placeholder="${t.questionPlaceholder}"></textarea><div class="flex-row"><button class="btn-primary" onclick="askQ()">${t.send}</button><button class="btn-secondary" onclick="hidAsk()">${t.cancel}</button></div></div>`:''}${myQ.length===0?`<p style="text-align:center;color:#6b7280;padding:40px 0">${t.noQuestions}</p>`:myQ.map(q=>`<div class="question-item"><div class="flex-between" style="margin-bottom:10px"><p class="message-time">${fmtTime(q.time)}</p>${q.answered?'<span class="badge badge-success">'+t.answered+'</span>':'<span class="badge badge-warning">'+t.awaitingResponse+'</span>'}</div><p style="margin:10px 0;padding:10px;background:white;border-radius:8px">${q.question}</p>${q.answered?`<div class="question-response"><strong>${t.response}:</strong> ${q.response}</div>`:''}</div>`).join('')}`}
function rProg(t){return `<h2 style="margin-bottom:20px">${t.progress}</h2>${S.pilgrims.length===0?`<p style="text-align:center;color:#6b7280;padding:40px 0">${t.noPilgrims}</p>`:S.pilgrims.map(p=>{const prog=calcProg(p.completedSteps),cnt=getCnt(p.completedSteps);return `<div class="pilgrim-item"><div class="flex-between" style="margin-bottom:10px"><div style="flex:1"><h3 style="margin:0">${p.name}</h3></div><button class="btn-primary btn-small" onclick="viewProg(${p.id})">${t.viewProgress}</button></div><div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div><p style="font-size:13px;color:#059669;font-weight:600;margin-top:5px">${cnt} ${t.of} 5 ${t.stepsCompleted} (${prog}%)</p>${prog===100?'<span class="badge badge-success">‚úì Oumrah termin√©e</span>':''}${prog===0?'<span class="badge badge-warning">Pas commenc√©</span>':''}</div>`}).join('')}`}
function rMsgs(t){return `<div class="flex-between" style="margin-bottom:20px"><h2 style="margin:0">${t.messages}</h2><button class="btn-primary btn-small" onclick="shwMsg()">+ ${t.addMessage}</button></div>${S.showAddMessage?`<div class="card" style="background:#f0fdf4"><h3>${t.addMessage}</h3><input type="text" id="msgT" placeholder="${t.messageTitle}"><textarea id="msgC" placeholder="${t.messageContent}"></textarea><div class="flex-row"><button class="btn-primary" onclick="sndMsg()">${t.send}</button><button class="btn-secondary" onclick="hidMsg()">${t.cancel}</button></div></div>`:''}${S.messages.length===0?`<p style="text-align:center;color:#6b7280;padding:40px 0">${t.noMessages}</p>`:S.messages.map(m=>`<div class="message-item"><div class="message-header"><h3 style="margin:0">${m.title}</h3><button class="btn-danger btn-small" onclick="delMsg(${m.id})">${t.delete}</button></div><p style="margin:10px 0">${m.content}</p><p class="message-time">${fmtTime(m.time)}</p></div>`).join('')}`}
function rRooms(t){const storedPilgrims=localStorage.getItem('pilgrims');if(storedPilgrims&&S.userType==='guide'){const allPilgrims=JSON.parse(storedPilgrims);S.pilgrims=allPilgrims.filter(p=>p.groupCode===S.currentGroup)}return `<div class="flex-between" style="margin-bottom:20px"><h2 style="margin:0">${t.rooms}</h2><button class="btn-primary btn-small" onclick="shwPil()">+ ${t.addPilgrim}</button></div>${S.showAddPilgrim?`<div class="card" style="background:#f0fdf4"><h3>${t.addPilgrim}</h3><input type="text" id="pilN" placeholder="${t.pilgrimName}"><input type="text" id="pilH" placeholder="Nom de l'h√¥tel"><input type="text" id="pilR" placeholder="${t.roomNumber}"><div class="flex-row"><button class="btn-primary" onclick="savPil()">${t.save}</button><button class="btn-secondary" onclick="hidPil()">${t.cancel}</button></div></div>`:''}${S.showEditPilgrim?`<div class="card" style="background:#fff3cd;border:2px solid #f59e0b"><h3>‚úèÔ∏è Modifier l'h√¥tel et la chambre</h3><input type="text" id="editH" placeholder="Nom de l'h√¥tel" value="${S.pilgrims.find(p=>p.id===S.editPilgrimId)?.hotel||''}"><input type="text" id="editR" placeholder="${t.roomNumber}" value="${S.pilgrims.find(p=>p.id===S.editPilgrimId)?.room||''}"><div class="flex-row"><button class="btn-primary" onclick="updatePil()">${t.save}</button><button class="btn-secondary" onclick="hidEditPil()">${t.cancel}</button></div></div>`:''}${S.pilgrims.length===0?`<p style="text-align:center;color:#6b7280;padding:40px 0">${t.noPilgrims}</p>`:S.pilgrims.map(p=>{const init=getInit(p.name);return `<div class="pilgrim-item"><div style="display:flex;flex-direction:column;gap:10px"><div class="flex-between"><div style="display:flex;align-items:center;gap:15px;flex:1"><div style="width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#059669 0%,#0d9488 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:18px;overflow:hidden;flex-shrink:0">${p.photo?`<img src="${p.photo}" style="width:100%;height:100%;object-fit:cover" alt="${p.name}">`:init}</div><div style="flex:1"><h3 style="margin-bottom:5px">${p.name}</h3><div style="display:flex;gap:10px;margin:5px 0;flex-wrap:wrap">${p.hotel?`<span class="badge badge-info">üè® ${p.hotel}</span>`:''}<span class="badge badge-info">üö™ ${p.room||'N/A'}</span><span class="badge badge-warning" style="font-family:monospace;font-size:13px">Code: ${p.code}</span></div></div></div><div style="display:flex;gap:5px"><button class="btn-warning btn-small" onclick="shwEditPil(${p.id})">‚úèÔ∏è</button><button class="btn-danger btn-small" onclick="delPil(${p.id})">üóëÔ∏è</button></div></div><button class="btn-success btn-small" onclick='sendWhatsApp(${JSON.stringify(p).replace(/'/g,"\\'")})'style="width:100%;background:#25D366;border-color:#25D366">üì± ${t.sendWhatsApp}</button></div></div>`}).join('')}`}
function rMap(t){return `<h2 style="margin-bottom:20px">${t.map}</h2><div class="card"><div style="position:relative"><button onclick="openGoogleMaps()" style="position:absolute;top:10px;right:10px;z-index:100;background:#059669;color:white;border:none;padding:12px 20px;border-radius:10px;font-weight:600;box-shadow:0 4px 15px rgba(5,150,105,0.4);cursor:pointer;display:flex;align-items:center;gap:8px"><span style="font-size:20px">üó∫Ô∏è</span><span>Ouvrir dans Maps</span></button><div style="background:linear-gradient(135deg,#d1fae5 0%,#a5f3fc 100%);height:300px;border-radius:15px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden"><p style="color:#047857;font-weight:600;z-index:10">Carte GPS interactive</p>${S.pilgrims.filter(p=>p.online).map((p,i)=>`<div style="position:absolute;left:${30+i*15}%;top:${40+i*10}%;width:30px;height:30px;background:#059669;border-radius:50%;border:3px solid white;box-shadow:0 4px 10px rgba(0,0,0,0.2)"></div>`).join('')}</div></div></div>${S.pilgrims.map(p=>`<div class="pilgrim-item"><div class="flex-between"><div><h3 style="margin:0">${p.name}</h3><p style="margin:5px 0 0 0;font-size:13px;color:#6b7280">${p.online?`<span class="status-online"></span>${t.online}`:`<span class="status-offline"></span>${t.offline}`}</p></div>${p.online?`<div style="display:flex;align-items:center;gap:10px"><p style="color:#059669;font-weight:600;margin:0">~${Math.floor(Math.random()*500)+100}m</p><button onclick="openPilgrimMaps(${p.lat||S.guideLocation.lat+0.001},${p.lng||S.guideLocation.lng+0.001},'${p.name}')" style="background:#059669;color:white;border:none;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:5px"><span>üó∫Ô∏è</span><span>Itin√©raire</span></button></div>`:''} </div></div>`).join('')}`}
function rPresence(t){return `<div class="flex-between" style="margin-bottom:20px"><h2 style="margin:0">${t.presence}</h2><button class="btn-primary btn-small" onclick="shwAct()">+ ${t.addActivity}</button></div>${S.showAddActivity?`<div class="card" style="background:#f0fdf4"><h3>${t.addActivity}</h3><input type="text" id="actN" placeholder="${t.activityName}"><input type="text" id="actL" placeholder="${t.activityLocation}"><label style="font-size:14px;color:#047857;font-weight:600;margin:15px 0 5px 0;display:block">üìÖ Date</label><input type="date" id="actD" style="margin-bottom:10px"><label style="font-size:14px;color:#047857;font-weight:600;margin:10px 0 5px 0;display:block">üïê Heure</label><input type="time" id="actT"><div class="flex-row"><button class="btn-primary" onclick="savAct()">${t.save}</button><button class="btn-secondary" onclick="hidAct()">${t.cancel}</button></div></div>`:''}${S.activities.length===0?`<p style="text-align:center;color:#6b7280;padding:40px 0">${t.noActivities}</p>`:S.activities.map(a=>{const pCnt=Object.values(a.presence||{}).filter(p=>p).length;return `<div class="activity-item"><div class="flex-between" style="margin-bottom:10px"><div style="flex:1"><h3 style="margin:0 0 5px 0">${a.name}</h3><p style="margin:0;font-size:14px;color:#6b7280">üìç ${a.location}</p><p style="margin:5px 0">üìÖ ${a.date||"Date non d√©finie"} ‚Ä¢ üïê ${a.time}</p><span class="badge badge-present">${pCnt} ${t.presenceCount}</span></div><button class="btn-danger btn-small" onclick="delAct(${a.id})">${t.delete}</button></div><div style="margin-top:15px;border-top:2px solid #e5e7eb;padding-top:15px"><h4 style="margin:0 0 10px 0;color:#059669;font-size:14px">${t.markPresence}</h4>${S.pilgrims.map(p=>{const pres=a.presence&&a.presence[p.id];return `<div class="checkbox-item"><input type="checkbox" ${pres?'checked':''} onchange="togPres(${a.id},${p.id})"><span>${p.name}</span>${pres?`<span class="badge badge-present" style="margin-left:auto">${t.present}</span>`:`<span class="badge badge-absent" style="margin-left:auto">${t.absent}</span>`}</div>`}).join('')}</div></div>`}).join('')}`}
R();
</script>
</body>
</html>
