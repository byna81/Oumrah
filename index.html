<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#059669">
    <title>Gestion Groupe Oumrah</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #d1fae5 0%, #99f6e4 50%, #a5f3fc 100%);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #047857;
            font-size: 28px;
            margin-bottom: 10px;
            text-align: center;
        }

        h2 {
            color: #047857;
            font-size: 22px;
            margin-bottom: 15px;
        }

        h3 {
            color: #059669;
            font-size: 18px;
            margin-bottom: 10px;
        }

        p {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: white;
            border: 2px solid #059669;
            color: #059669;
        }

        .btn-small {
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
            display: inline-block;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-reset {
            background: #e5e7eb;
            color: #374151;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        textarea {
            min-height: 100px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #059669;
        }

        .hidden {
            display: none;
        }

        .tab-bar {
            background: white;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 80px;
            padding: 15px 10px;
            text-align: center;
            border: none;
            background: white;
            color: #6b7280;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab.active {
            color: #059669;
            border-bottom-color: #059669;
        }

        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .icon-circle {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .code-display {
            background: #d1fae5;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-family: monospace;
            font-size: 24px;
            font-weight: bold;
            color: #047857;
            margin: 15px 0;
        }

        .pilgrim-item, .message-item, .activity-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #e5e7eb;
        }

        .pilgrim-item:hover {
            border-color: #059669;
        }

        .status-online {
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-offline {
            width: 10px;
            height: 10px;
            background: #6b7280;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .label {
            font-size: 12px;
            font-weight: 600;
            color: #047857;
            margin-bottom: 5px;
            display: block;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }

        .badge-present {
            background: #dcfce7;
            color: #166534;
        }

        .badge-absent {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .room-photo {
            width: 100%;
            max-width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: white;
            border-radius: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-time {
            font-size: 12px;
            color: #6b7280;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #059669 0%, #10b981 100%);
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 600;
            color: #059669;
            text-align: center;
            margin-top: 5px;
        }

        ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        ol li {
            margin-bottom: 8px;
            color: #374151;
        }

        .rite-item {
            border: 2px solid #d1fae5;
            border-radius: 15px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .rite-item.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .rite-header {
            padding: 20px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rite-header:active {
            background: #f0fdf4;
        }

        .rite-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .rite-number.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .rite-content {
            padding: 20px;
            background: #f0fdf4;
            border-top: 2px solid #d1fae5;
        }

        .dua-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #d1fae5;
        }

        .arabic-text {
            font-size: 24px;
            line-height: 1.8;
            text-align: right;
            direction: rtl;
            color: #1f2937;
        }

        .phonetic-text {
            font-style: italic;
            color: #6b7280;
            font-size: 14px;
        }

        .translation-text {
            color: #374151;
            font-size: 14px;
        }

        .counter-circle {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.4);
        }

        .counter-number {
            font-size: 60px;
            font-weight: bold;
            color: white;
        }

        .success-box {
            background: #dcfce7;
            border: 2px solid #22c55e;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .success-text {
            color: #166534;
            font-weight: bold;
            font-size: 16px;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-checkbox-label {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
        }

        .step-checkbox-label:hover {
            border-color: #059669;
        }

        .step-checkbox-label.checked {
            background: #f0fdf4;
            border-color: #10b981;
        }

        .step-checkbox-label input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            cursor: pointer;
        }

        .step-name {
            flex: 1;
            font-weight: 500;
            color: #374151;
        }

        .step-checkbox-label.checked .step-name {
            color: #059669;
        }

        .checkmark {
            color: #10b981;
            font-size: 20px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // État de l'application
        let state = {
            language: 'fr',
            userType: null,
            userName: '',
            groupCode: '',
            currentGroup: null,
            activeTab: 'rites',
            expandedRite: null,
            tawafCount: 0,
            saiCount: 0,
            messages: [],
            pilgrims: [],
            activities: [],
            completedSteps: {}, // Pour les pèlerins: {riteId: true/false}
            showAddMessage: false,
            showAddPilgrim: false,
            showAddActivity: false,
            viewPilgrimProgress: null
        };

        // Traductions
        const t = {
            fr: {
                appTitle: "Gestion Groupe Oumrah",
                guide: "Guide",
                pilgrims: "Pèlerins",
                userType: "Choisissez votre rôle",
                enterName: "Entrez votre nom",
                create: "Créer un groupe",
                join: "Rejoindre",
                enterCode: "Entrez le code du groupe",
                yourCode: "Votre code de groupe :",
                shareCode: "Partagez ce code avec vos pèlerins",
                rites: "Rites",
                messages: "Messages",
                rooms: "Chambres",
                map: "Carte",
                presence: "Présence",
                progress: "Progression",
                steps: "Étapes",
                invocation: "Invocation",
                phonetic: "Phonétique",
                translation: "Traduction",
                counter: "Compteur",
                round: "Tour",
                trip: "Trajet",
                reset: "Réinitialiser",
                tawafComplete: "Tawaf terminé ! 7 tours accomplis ✓",
                saiComplete: "Sa'i terminé ! 7 trajets accomplis ✓",
                back: "← Retour",
                addMessage: "Nouveau message",
                messageTitle: "Titre du message",
                messageContent: "Contenu du message",
                send: "Envoyer",
                cancel: "Annuler",
                noMessages: "Aucun message pour le moment",
                addPilgrim: "Ajouter un pèlerin",
                pilgrimName: "Nom du pèlerin",
                roomNumber: "Numéro de chambre",
                floor: "Étage",
                addPhoto: "Ajouter une photo",
                save: "Enregistrer",
                noPilgrims: "Aucun pèlerin enregistré",
                room: "Chambre",
                online: "En ligne",
                offline: "Hors ligne",
                addActivity: "Nouvelle activité",
                activityName: "Nom de l'activité",
                activityLocation: "Lieu",
                activityTime: "Heure",
                noActivities: "Aucune activité planifiée",
                markPresence: "Marquer les présences",
                present: "Présent",
                absent: "Absent",
                presenceCount: "présents",
                closePresence: "Fermer",
                delete: "Supprimer",
                myProgress: "Ma progression",
                markAsCompleted: "Marquer comme terminé",
                completed: "Terminé",
                notStarted: "Pas encore commencé",
                viewProgress: "Voir la progression",
                pilgrimProgress: "Progression du pèlerin",
                of: "sur",
                stepsCompleted: "étapes terminées"
            },
            en: {
                appTitle: "Umrah Group Management",
                guide: "Guide",
                pilgrims: "Pilgrims",
                userType: "Choose your role",
                enterName: "Enter your name",
                create: "Create group",
                join: "Join",
                enterCode: "Enter group code",
                yourCode: "Your group code:",
                shareCode: "Share this code with your pilgrims",
                rites: "Rites",
                messages: "Messages",
                rooms: "Rooms",
                map: "Map",
                presence: "Attendance",
                progress: "Progress",
                steps: "Steps",
                invocation: "Invocation",
                phonetic: "Phonetic",
                translation: "Translation",
                counter: "Counter",
                round: "Round",
                trip: "Trip",
                reset: "Reset",
                tawafComplete: "Tawaf completed! 7 rounds done ✓",
                saiComplete: "Sa'i completed! 7 trips done ✓",
                back: "← Back",
                addMessage: "New message",
                messageTitle: "Message title",
                messageContent: "Message content",
                send: "Send",
                cancel: "Cancel",
                noMessages: "No messages yet",
                addPilgrim: "Add pilgrim",
                pilgrimName: "Pilgrim name",
                roomNumber: "Room number",
                floor: "Floor",
                addPhoto: "Add photo",
                save: "Save",
                noPilgrims: "No pilgrims registered",
                room: "Room",
                online: "Online",
                offline: "Offline",
                addActivity: "New activity",
                activityName: "Activity name",
                activityLocation: "Location",
                activityTime: "Time",
                noActivities: "No activities planned",
                markPresence: "Mark attendance",
                present: "Present",
                absent: "Absent",
                presenceCount: "present",
                closePresence: "Close",
                delete: "Delete",
                myProgress: "My progress",
                markAsCompleted: "Mark as completed",
                completed: "Completed",
                notStarted: "Not started yet",
                viewProgress: "View progress",
                pilgrimProgress: "Pilgrim progress",
                of: "of",
                stepsCompleted: "steps completed"
            }
        };

        // Données des rites
        const rites = {
            fr: [
                {
                    id: 1,
                    title: "Ihram",
                    description: "État de sacralisation avant d'entrer dans les lieux saints",
                    steps: [
                        "Se purifier (ghusl) et porter les vêtements d'Ihram",
                        "Formuler l'intention (niyyah) pour la Oumrah",
                        "Réciter la Talbiyah"
                    ],
                    dua: {
                        arabic: "لَبَّيْكَ اللَّهُمَّ لَبَّيْكَ، لَبَّيْكَ لَا شَرِيكَ لَكَ لَبَّيْكَ، إِنَّ الْحَمْدَ وَالنِّعْمَةَ لَكَ وَالْمُلْكَ، لَا شَرِيكَ لَكَ",
                        phonetic: "Labbayka Allāhumma labbayk, labbayka lā sharīka laka labbayk, inna al-ḥamda wa n-niʿmata laka wa l-mulk, lā sharīka lak",
                        translation: "Me voici, Ô Allah, me voici. Me voici, Tu n'as pas d'associé, me voici. Certes la louange, la grâce et la royauté T'appartiennent. Tu n'as pas d'associé."
                    }
                },
                {
                    id: 2,
                    title: "Tawaf",
                    description: "Sept circumambulations autour de la Kaaba",
                    steps: [
                        "Commencer au niveau de la Pierre Noire (Hajar al-Aswad)",
                        "Effectuer 7 tours autour de la Kaaba dans le sens antihoraire",
                        "Toucher ou pointer la Pierre Noire à chaque tour si possible",
                        "Réciter les invocations pendant le Tawaf"
                    ],
                    dua: {
                        arabic: "سُبْحَانَ اللهِ وَالْحَمْدُ لِلَّهِ وَلَا إِلَهَ إِلَّا اللهُ وَاللهُ أَكْبَرُ وَلَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللهِ",
                        phonetic: "Subḥāna Llāh, wa l-ḥamdu li-Llāh, wa lā ilāha illā Llāh, wa Llāhu akbar, wa lā ḥawla wa lā quwwata illā bi-Llāh",
                        translation: "Gloire à Allah, louange à Allah, il n'y a de divinité qu'Allah, Allah est le Plus Grand, il n'y a de force ni de puissance qu'en Allah."
                    }
                },
                {
                    id: 3,
                    title: "Prière de deux unités",
                    description: "Prière derrière Maqam Ibrahim",
                    steps: [
                        "Se diriger vers Maqam Ibrahim après le Tawaf",
                        "Accomplir deux rak'at (unités de prière)",
                        "Réciter sourate Al-Kafirun dans la 1ère rak'a",
                        "Réciter sourate Al-Ikhlas dans la 2ème rak'a"
                    ],
                    dua: {
                        arabic: "رَبَّنَا تَقَبَّلْ مِنَّا إِنَّكَ أَنْتَ السَّمِيعُ الْعَلِيمُ",
                        phonetic: "Rabbanā taqabbal minnā innaka anta s-samīʿu l-ʿalīm",
                        translation: "Notre Seigneur, accepte de nous, Tu es certes Celui qui entend et qui sait."
                    }
                },
                {
                    id: 4,
                    title: "Sa'i",
                    description: "Sept allers-retours entre Safa et Marwa",
                    steps: [
                        "Commencer à Safa en regardant la Kaaba",
                        "Réciter le Takbir (3 fois) et les invocations",
                        "Marcher vers Marwa (1er trajet)",
                        "Retourner vers Safa (2ème trajet)",
                        "Répéter jusqu'à compléter 7 trajets (fin à Marwa)"
                    ],
                    dua: {
                        arabic: "إِنَّ الصَّفَا وَالْمَرْوَةَ مِنْ شَعَائِرِ اللَّهِ • اللهُ أَكْبَرُ، اللهُ أَكْبَرُ، اللهُ أَكْبَرُ",
                        phonetic: "Inna ṣ-ṣafā wa l-marwata min shaʿāʾiri Llāh • Allahou Akbar, Allahou Akbar, Allahou Akbar",
                        translation: "Certes Safa et Marwa sont parmi les rites d'Allah. • Allah est le Plus Grand, Allah est le Plus Grand, Allah est le Plus Grand."
                    }
                },
                {
                    id: 5,
                    title: "Taqsir ou Halq",
                    description: "Raccourcir ou raser les cheveux",
                    steps: [
                        "Les hommes peuvent raser (Halq) ou raccourcir (Taqsir) leurs cheveux",
                        "Les femmes coupent l'équivalent d'une phalange de leurs cheveux",
                        "Ceci marque la fin de la Oumrah",
                        "L'état d'Ihram prend fin"
                    ],
                    dua: {
                        arabic: "الْحَمْدُ لِلَّهِ الَّذِي قَضَى عَنَّا نُسُكَنَا",
                        phonetic: "Al-ḥamdu li-Llāhi lladhī qaḍā ʿannā nusukana",
                        translation: "Louange à Allah qui nous a permis d'accomplir notre rite."
                    }
                }
            ],
            en: [
                {
                    id: 1,
                    title: "Ihram",
                    description: "State of consecration before entering the holy sites",
                    steps: [
                        "Perform purification (ghusl) and wear Ihram garments",
                        "Make intention (niyyah) for Umrah",
                        "Recite the Talbiyah"
                    ],
                    dua: {
                        arabic: "لَبَّيْكَ اللَّهُمَّ لَبَّيْكَ، لَبَّيْكَ لَا شَرِيكَ لَكَ لَبَّيْكَ، إِنَّ الْحَمْدَ وَالنِّعْمَةَ لَكَ وَالْمُلْكَ، لَا شَرِيكَ لَكَ",
                        phonetic: "Labbayka Allāhumma labbayk, labbayka lā sharīka laka labbayk, inna al-ḥamda wa n-niʿmata laka wa l-mulk, lā sharīka lak",
                        translation: "Here I am, O Allah, here I am. Here I am, You have no partner, here I am. Verily, all praise, grace and sovereignty belong to You. You have no partner."
                    }
                },
                {
                    id: 2,
                    title: "Tawaf",
                    description: "Seven circumambulations around the Kaaba",
                    steps: [
                        "Start at the Black Stone (Hajar al-Aswad)",
                        "Perform 7 circles around the Kaaba counterclockwise",
                        "Touch or point to the Black Stone each round if possible",
                        "Recite invocations during Tawaf"
                    ],
                    dua: {
                        arabic: "سُبْحَانَ اللهِ وَالْحَمْدُ لِلَّهِ وَلَا إِلَهَ إِلَّا اللهُ وَاللهُ أَكْبَرُ وَلَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللهِ",
                        phonetic: "Subḥāna Llāh, wa l-ḥamdu li-Llāh, wa lā ilāha illā Llāh, wa Llāhu akbar, wa lā ḥawla wa lā quwwata illā bi-Llāh",
                        translation: "Glory be to Allah, praise be to Allah, there is no god but Allah, Allah is the Greatest, there is no power nor strength except with Allah."
                    }
                },
                {
                    id: 3,
                    title: "Two units prayer",
                    description: "Prayer behind Maqam Ibrahim",
                    steps: [
                        "Go to Maqam Ibrahim after Tawaf",
                        "Perform two rak'at (prayer units)",
                        "Recite Surah Al-Kafirun in the 1st rak'a",
                        "Recite Surah Al-Ikhlas in the 2nd rak'a"
                    ],
                    dua: {
                        arabic: "رَبَّنَا تَقَبَّلْ مِنَّا إِنَّكَ أَنْتَ السَّمِيعُ الْعَلِيمُ",
                        phonetic: "Rabbanā taqabbal minnā innaka anta s-samīʿu l-ʿalīm",
                        translation: "Our Lord, accept from us. Indeed, You are the Hearing, the Knowing."
                    }
                },
                {
                    id: 4,
                    title: "Sa'i",
                    description: "Seven trips between Safa and Marwa",
                    steps: [
                        "Start at Safa facing the Kaaba",
                        "Recite the Takbir (3 times) and invocations",
                        "Walk to Marwa (1st trip)",
                        "Return to Safa (2nd trip)",
                        "Repeat until completing 7 trips (ending at Marwa)"
                    ],
                    dua: {
                        arabic: "إِنَّ الصَّفَا وَالْمَرْوَةَ مِنْ شَعَائِرِ اللَّهِ • اللهُ أَكْبَرُ، اللهُ أَكْبَرُ، اللهُ أَكْبَرُ",
                        phonetic: "Inna ṣ-ṣafā wa l-marwata min shaʿāʾiri Llāh • Allahou Akbar, Allahou Akbar, Allahou Akbar",
                        translation: "Indeed, Safa and Marwa are among the symbols of Allah. • Allah is the Greatest, Allah is the Greatest, Allah is the Greatest."
                    }
                },
                {
                    id: 5,
                    title: "Taqsir or Halq",
                    description: "Shortening or shaving the hair",
                    steps: [
                        "Men can shave (Halq) or shorten (Taqsir) their hair",
                        "Women cut the equivalent of a fingertip from their hair",
                        "This marks the end of Umrah",
                        "The state of Ihram ends"
                    ],
                    dua: {
                        arabic: "الْحَمْدُ لِلَّهِ الَّذِي قَضَى عَنَّا نُسُكَنَا",
                        phonetic: "Al-ḥamdu li-Llāhi lladhī qaḍā ʿannā nusukana",
                        translation: "Praise be to Allah who enabled us to complete our ritual."
                    }
                }
            ]
        };

        // Données de démonstration
        function initDemoData() {
            if (state.userType === 'guide' && state.currentGroup && state.pilgrims.length === 0) {
                state.pilgrims = [
                    { 
                        id: 1, 
                        name: 'Ahmed Ben Ali', 
                        room: '205', 
                        floor: '2', 
                        online: true, 
                        lat: 21.4225, 
                        lng: 39.8262,
                        completedSteps: {1: true, 2: true, 3: false, 4: false, 5: false}
                    },
                    { 
                        id: 2, 
                        name: 'Fatima Zahra', 
                        room: '207', 
                        floor: '2', 
                        online: true, 
                        lat: 21.4235, 
                        lng: 39.8272,
                        completedSteps: {1: true, 2: true, 3: true, 4: true, 5: false}
                    },
                    { 
                        id: 3, 
                        name: 'Mohammed Ibrahim', 
                        room: '305', 
                        floor: '3', 
                        online: false, 
                        lat: 21.4215, 
                        lng: 39.8252,
                        completedSteps: {1: true, 2: false, 3: false, 4: false, 5: false}
                    },
                    { 
                        id: 4, 
                        name: 'Khadija Nour', 
                        room: '308', 
                        floor: '3', 
                        online: true, 
                        lat: 21.4240, 
                        lng: 39.8280,
                        completedSteps: {1: true, 2: true, 3: true, 4: true, 5: true}
                    }
                ];

                state.messages = [
                    { id: 1, title: 'Départ demain matin', content: 'Rendez-vous à 6h dans le lobby de l\'hôtel', time: new Date(Date.now() - 3600000) }
                ];

                state.activities = [
                    { id: 1, name: 'Visite de la Mosquée du Prophète', location: 'Médine', time: '09:00', presence: {} },
                    { id: 2, name: 'Tawaf de groupe', location: 'Masjid al-Haram', time: '14:00', presence: {} }
                ];
            }
        }

        // Fonctions utilitaires
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'à l\'instant';
            if (minutes < 60) return `il y a ${minutes} min`;
            if (hours < 24) return `il y a ${hours}h`;
            return `il y a ${days}j`;
        }

        function calculateProgress(completedSteps) {
            if (!completedSteps) return 0;
            const completed = Object.values(completedSteps).filter(v => v).length;
            return Math.round((completed / 5) * 100);
        }

        function getCompletedCount(completedSteps) {
            if (!completedSteps) return 0;
            return Object.values(completedSteps).filter(v => v).length;
        }

        // Fonctions d'interaction
        function selectUserType(type) {
            state.userType = type;
            render();
        }

        function changeLanguage(lang) {
            state.language = lang;
            render();
        }

        function goBack() {
            state.userType = null;
            state.currentGroup = null;
            state.groupCode = '';
            state.userName = '';
            state.viewPilgrimProgress = null;
            render();
        }

        function createGroup() {
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            state.currentGroup = code;
            state.groupCode = code;
            initDemoData();
            render();
        }

        function joinGroup() {
            const name = document.getElementById('pilgrimNameInput').value;
            const code = document.getElementById('codeInput').value;
            
            if (name && code && code.length >= 6) {
                state.userName = name;
                state.currentGroup = code.toUpperCase();
                state.completedSteps = {1: false, 2: false, 3: false, 4: false, 5: false};
                render();
            }
        }

        function toggleRite(id) {
            state.expandedRite = state.expandedRite === id ? null : id;
            render();
        }

        function toggleStepCompletion(riteId) {
            if (state.userType === 'pilgrim') {
                state.completedSteps[riteId] = !state.completedSteps[riteId];
                render();
            }
        }

        function incrementTawaf() {
            if (state.tawafCount < 7) {
                state.tawafCount++;
                render();
            }
        }

        function resetTawaf() {
            state.tawafCount = 0;
            render();
        }

        function incrementSai() {
            if (state.saiCount < 7) {
                state.saiCount++;
                render();
            }
        }

        function resetSai() {
            state.saiCount = 0;
            render();
        }

        function showAddMessageForm() {
            state.showAddMessage = true;
            render();
        }

        function hideAddMessageForm() {
            state.showAddMessage = false;
            render();
        }

        function sendMessage() {
            const title = document.getElementById('msgTitle').value;
            const content = document.getElementById('msgContent').value;
            
            if (title && content) {
                state.messages.unshift({
                    id: Date.now(),
                    title: title,
                    content: content,
                    time: new Date()
                });
                state.showAddMessage = false;
                render();
            }
        }

        function deleteMessage(id) {
            state.messages = state.messages.filter(m => m.id !== id);
            render();
        }

        function showAddPilgrimForm() {
            state.showAddPilgrim = true;
            render();
        }

        function hideAddPilgrimForm() {
            state.showAddPilgrim = false;
            render();
        }

        function savePilgrim() {
            const name = document.getElementById('pilgrimName').value;
            const room = document.getElementById('roomNumber').value;
            const floor = document.getElementById('floorNumber').value;
            
            if (name) {
                state.pilgrims.push({
                    id: Date.now(),
                    name: name,
                    room: room || 'N/A',
                    floor: floor || 'N/A',
                    online: true,
                    lat: 21.4225 + Math.random() * 0.01,
                    lng: 39.8262 + Math.random() * 0.01,
                    completedSteps: {1: false, 2: false, 3: false, 4: false, 5: false}
                });
                state.showAddPilgrim = false;
                render();
            }
        }

        function deletePilgrim(id) {
            state.pilgrims = state.pilgrims.filter(p => p.id !== id);
            render();
        }

        function showAddActivityForm() {
            state.showAddActivity = true;
            render();
        }

        function hideAddActivityForm() {
            state.showAddActivity = false;
            render();
        }

        function saveActivity() {
            const name = document.getElementById('activityName').value;
            const location = document.getElementById('activityLocation').value;
            const time = document.getElementById('activityTime').value;
            
            if (name && location && time) {
                state.activities.push({
                    id: Date.now(),
                    name: name,
                    location: location,
                    time: time,
                    presence: {}
                });
                state.showAddActivity = false;
                render();
            }
        }

        function deleteActivity(id) {
            state.activities = state.activities.filter(a => a.id !== id);
            render();
        }

        function togglePresence(activityId, pilgrimId) {
            const activity = state.activities.find(a => a.id === activityId);
            if (activity) {
                if (!activity.presence) activity.presence = {};
                activity.presence[pilgrimId] = !activity.presence[pilgrimId];
                render();
            }
        }

        function viewPilgrimProgress(pilgrimId) {
            state.viewPilgrimProgress = pilgrimId;
            render();
        }

        function closeProgressView() {
            state.viewPilgrimProgress = null;
            render();
        }

        // Rendu de l'application
        function render() {
            const app = document.getElementById('app');
            const lang = state.language;
            const tr = t[lang];

            if (!state.userType) {
                app.innerHTML = renderUserSelection(tr);
            } else if (!state.currentGroup) {
                app.innerHTML = renderGroupJoin(tr);
            } else if (state.viewPilgrimProgress) {
                app.innerHTML = renderPilgrimProgressView(tr, lang);
            } else {
                app.innerHTML = renderMainApp(tr, lang);
            }
        }

        function renderUserSelection(tr) {
            return `
                <div class="container">
                    <div class="card">
                        <div class="icon-circle">
                            <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                        </div>
                        <h1>${tr.appTitle}</h1>
                        <p style="text-align: center; margin-bottom: 30px;">${tr.userType}</p>
                        
                        <button class="btn-primary" onclick="selectUserType('guide')">${tr.guide}</button>
                        <button class="btn-secondary" onclick="selectUserType('pilgrim')">${tr.pilgrims}</button>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <select onchange="changeLanguage(this.value)" style="width: auto; display: inline-block;">
                                <option value="fr" ${state.language === 'fr' ? 'selected' : ''}>Français</option>
                                <option value="en" ${state.language === 'en' ? 'selected' : ''}>English</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGroupJoin(tr) {
            return `
                <div class="container">
                    <div class="card">
                        <button class="btn-secondary" onclick="goBack()" style="margin-bottom: 20px;">${tr.back}</button>
                        <h2>${state.userType === 'guide' ? tr.create : tr.join}</h2>
                        
                        ${state.userType === 'guide' ? `
                            <button class="btn-primary" onclick="createGroup()">${tr.create}</button>
                        ` : `
                            <input type="text" id="pilgrimNameInput" placeholder="${tr.enterName}">
                            <input type="text" id="codeInput" placeholder="${tr.enterCode}" maxlength="6" style="text-transform: uppercase; text-align: center; font-size: 20px;">
                            <button class="btn-primary" onclick="joinGroup()">${tr.join}</button>
                        `}
                    </div>
                </div>
            `;
        }

        function renderPilgrimProgressView(tr, lang) {
            const pilgrim = state.pilgrims.find(p => p.id === state.viewPilgrimProgress);
            if (!pilgrim) return '';

            const currentRites = rites[lang];
            const progress = calculateProgress(pilgrim.completedSteps);
            const completed = getCompletedCount(pilgrim.completedSteps);

            return `
                <div class="container">
                    <div class="card">
                        <button class="btn-secondary" onclick="closeProgressView()" style="margin-bottom: 20px;">${tr.back}</button>
                        
                        <h2>${tr.pilgrimProgress}</h2>
                        <h3 style="text-align: center; color: #059669; margin-bottom: 20px;">${pilgrim.name}</h3>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%;"></div>
                        </div>
                        <p class="progress-text">${completed} ${tr.of} 5 ${tr.stepsCompleted} (${progress}%)</p>
                        
                        <div style="margin-top: 30px;">
                            ${currentRites.map((rite, index) => {
                                const isCompleted = pilgrim.completedSteps && pilgrim.completedSteps[rite.id];
                                return `
                                    <div class="rite-item ${isCompleted ? 'completed' : ''}">
                                        <div class="rite-header">
                                            <div style="display: flex; align-items: center; flex: 1;">
                                                <div class="rite-number ${isCompleted ? 'completed' : ''}">${index + 1}</div>
                                                <div style="flex: 1;">
                                                    <h3 style="margin: 0;">${rite.title}</h3>
                                                    <p style="margin: 5px 0 0 0; font-size: 14px; color: ${isCompleted ? '#059669' : '#6b7280'};">
                                                        ${isCompleted ? '✓ ' + tr.completed : tr.notStarted}
                                                    </p>
                                                </div>
                                            </div>
                                            ${isCompleted ? '<span class="checkmark">✓</span>' : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp(tr, lang) {
            const currentRites = rites[lang];
            
            let tabsHTML = '';
            if (state.userType === 'guide') {
                tabsHTML = `
                    <button class="tab ${state.activeTab === 'rites' ? 'active' : ''}" onclick="state.activeTab='rites'; render();">${tr.rites}</button>
                    <button class="tab ${state.activeTab === 'progress' ? 'active' : ''}" onclick="state.activeTab='progress'; render();">${tr.progress}</button>
                    <button class="tab ${state.activeTab === 'messages' ? 'active' : ''}" onclick="state.activeTab='messages'; render();">${tr.messages}</button>
                    <button class="tab ${state.activeTab === 'rooms' ? 'active' : ''}" onclick="state.activeTab='rooms'; render();">${tr.rooms}</button>
                    <button class="tab ${state.activeTab === 'map' ? 'active' : ''}" onclick="state.activeTab='map'; render();">${tr.map}</button>
                    <button class="tab ${state.activeTab === 'presence' ? 'active' : ''}" onclick="state.activeTab='presence'; render();">${tr.presence}</button>
                `;
            } else {
                tabsHTML = `
                    <button class="tab ${state.activeTab === 'rites' ? 'active' : ''}" onclick="state.activeTab='rites'; render();">${tr.rites}</button>
                    <button class="tab ${state.activeTab === 'myprogress' ? 'active' : ''}" onclick="state.activeTab='myprogress'; render();">${tr.myProgress}</button>
                `;
            }
            
            return `
                <div class="header">
                    <h1 style="margin-bottom: 5px;">${tr.appTitle}</h1>
                    <p style="text-align: center; color: #6b7280;">${state.userType === 'guide' ? tr.guide : state.userName}</p>
                    <div class="code-display">${state.currentGroup}</div>
                    <p style="text-align: center; font-size: 12px; color: #6b7280;">${tr.shareCode}</p>
                    <div style="text-align: center; margin-top: 15px;">
                        <select onchange="changeLanguage(this.value)" style="width: auto; display: inline-block;">
                            <option value="fr" ${lang === 'fr' ? 'selected' : ''}>Français</option>
                            <option value="en" ${lang === 'en' ? 'selected' : ''}>English</option>
                        </select>
                    </div>
                </div>

                <div class="tab-bar">
                    ${tabsHTML}
                </div>

                <div class="container">
                    ${renderTabContent(tr, lang, currentRites)}
                </div>
            `;
        }

        function renderTabContent(tr, lang, currentRites) {
            switch(state.activeTab) {
                case 'rites':
                    return renderRites(tr, currentRites);
                case 'progress':
                    return renderProgress(tr);
                case 'myprogress':
                    return renderMyProgress(tr, currentRites);
                case 'messages':
                    return renderMessages(tr);
                case 'rooms':
                    return renderRooms(tr);
                case 'map':
                    return renderMap(tr);
                case 'presence':
                    return renderPresence(tr);
                default:
                    return '';
            }
        }

        function renderRites(tr, currentRites) {
            return `
                <h2 style="margin-bottom: 20px;">${tr.rites}</h2>
                ${currentRites.map((rite, index) => {
                    const isCompleted = state.userType === 'pilgrim' && state.completedSteps && state.completedSteps[rite.id];
                    return `
                        <div class="rite-item ${isCompleted ? 'completed' : ''}">
                            <div class="rite-header" onclick="toggleRite(${rite.id})">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    <div class="rite-number ${isCompleted ? 'completed' : ''}">${index + 1}</div>
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0;">${rite.title}</h3>
                                        <p style="margin: 5px 0 0 0; font-size: 14px;">${rite.description}</p>
                                    </div>
                                </div>
                                <div style="font-size: 24px; color: #059669;">${state.expandedRite === rite.id ? '−' : '+'}</div>
                            </div>
                            
                            ${state.expandedRite === rite.id ? `
                                <div class="rite-content">
                                    <h3>${tr.steps}</h3>
                                    <ol>
                                        ${rite.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                    
                                    <h3 style="margin-top: 20px;">${tr.invocation}</h3>
                                    
                                    <div class="dua-box">
                                        <div class="arabic-text">${rite.dua.arabic}</div>
                                    </div>
                                    
                                    <div class="dua-box">
                                        <span class="label">${tr.phonetic}</span>
                                        <div class="phonetic-text">${rite.dua.phonetic}</div>
                                    </div>
                                    
                                    <div class="dua-box">
                                        <span class="label">${tr.translation}</span>
                                        <div class="translation-text">${rite.dua.translation}</div>
                                    </div>
                                    
                                    ${rite.id === 2 ? `
                                        <div style="margin-top: 20px; background: white; padding: 20px; border-radius: 15px; border: 2px solid #059669;">
                                            <h3 style="text-align: center;">${tr.counter}</h3>
                                            <div class="counter-circle">
                                                <div class="counter-number">${state.tawafCount}</div>
                                            </div>
                                            <p style="text-align: center; font-weight: 600; margin-bottom: 15px;">${tr.round} ${state.tawafCount}/7</p>
                                            ${state.tawafCount < 7 ? `
                                                <button class="btn-primary" onclick="incrementTawaf()">+ 1 ${tr.round}</button>
                                            ` : `
                                                <div class="success-box">
                                                    <div class="success-text">${tr.tawafComplete}</div>
                                                </div>
                                                <button class="btn-reset" onclick="resetTawaf()">${tr.reset}</button>
                                            `}
                                        </div>
                                    ` : ''}
                                    
                                    ${rite.id === 4 ? `
                                        <div style="margin-top: 20px; background: white; padding: 20px; border-radius: 15px; border: 2px solid #059669;">
                                            <h3 style="text-align: center;">${tr.counter}</h3>
                                            <div class="counter-circle">
                                                <div class="counter-number">${state.saiCount}</div>
                                            </div>
                                            <p style="text-align: center; font-weight: 600; margin-bottom: 15px;">${tr.trip} ${state.saiCount}/7</p>
                                            ${state.saiCount < 7 ? `
                                                <button class="btn-primary" onclick="incrementSai()">+ 1 ${tr.trip}</button>
                                            ` : `
                                                <div class="success-box">
                                                    <div class="success-text">${tr.saiComplete}</div>
                                                </div>
                                                <button class="btn-reset" onclick="resetSai()">${tr.reset}</button>
                                            `}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderMyProgress(tr, currentRites) {
            const progress = calculateProgress(state.completedSteps);
            const completed = getCompletedCount(state.completedSteps);

            return `
                <h2 style="margin-bottom: 10px;">${tr.myProgress}</h2>
                <p style="text-align: center; color: #6b7280; margin-bottom: 20px;">${state.userName}</p>
                
                <div class="card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%;"></div>
                    </div>
                    <p class="progress-text">${completed} ${tr.of} 5 ${tr.stepsCompleted} (${progress}%)</p>
                </div>

                <h3 style="margin: 20px 0 15px 0;">${tr.markAsCompleted}</h3>
                
                ${currentRites.map((rite) => {
                    const isCompleted = state.completedSteps && state.completedSteps[rite.id];
                    return `
                        <label class="step-checkbox-label ${isCompleted ? 'checked' : ''}" onclick="toggleStepCompletion(${rite.id})">
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} onclick="event.stopPropagation()">
                            <span class="step-name">${rite.title}</span>
                            ${isCompleted ? '<span class="checkmark">✓</span>' : ''}
                        </label>
                    `;
                }).join('')}

                ${progress === 100 ? `
                    <div class="success-box" style="margin-top: 20px;">
                        <div class="success-text">🎉 ${tr.completed} ! Félicitations pour avoir terminé votre Oumrah !</div>
                    </div>
                ` : ''}
            `;
        }

        function renderProgress(tr) {
            return `
                <h2 style="margin-bottom: 20px;">${tr.progress}</h2>
                
                ${state.pilgrims.length === 0 ? `
                    <p style="text-align: center; color: #6b7280; padding: 40px 0;">${tr.noPilgrims}</p>
                ` : state.pilgrims.map(pilgrim => {
                    const progress = calculateProgress(pilgrim.completedSteps);
                    const completed = getCompletedCount(pilgrim.completedSteps);
                    return `
                        <div class="pilgrim-item">
                            <div class="flex-between" style="margin-bottom: 10px;">
                                <h3 style="margin: 0;">${pilgrim.name}</h3>
                                <button class="btn-primary btn-small" onclick="viewPilgrimProgress(${pilgrim.id})">${tr.viewProgress}</button>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%;"></div>
                            </div>
                            <p style="font-size: 13px; color: #059669; font-weight: 600; margin-top: 5px;">
                                ${completed} ${tr.of} 5 ${tr.stepsCompleted} (${progress}%)
                            </p>
                            ${progress === 100 ? '<span class="badge badge-success">✓ Oumrah terminée</span>' : ''}
                            ${progress === 0 ? '<span class="badge badge-warning">Pas commencé</span>' : ''}
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderMessages(tr) {
            return `
                <div class="flex-between" style="margin-bottom: 20px;">
                    <h2 style="margin: 0;">${tr.messages}</h2>
                    <button class="btn-primary btn-small" onclick="showAddMessageForm()">+ ${tr.addMessage}</button>
                </div>

                ${state.showAddMessage ? `
                    <div class="card" style="background: #f0fdf4;">
                        <h3>${tr.addMessage}</h3>
                        <input type="text" id="msgTitle" placeholder="${tr.messageTitle}">
                        <textarea id="msgContent" placeholder="${tr.messageContent}"></textarea>
                        <div class="flex-row">
                            <button class="btn-primary" onclick="sendMessage()">${tr.send}</button>
                            <button class="btn-secondary" onclick="hideAddMessageForm()">${tr.cancel}</button>
                        </div>
                    </div>
                ` : ''}

                ${state.messages.length === 0 ? `
                    <p style="text-align: center; color: #6b7280; padding: 40px 0;">${tr.noMessages}</p>
                ` : state.messages.map(msg => `
                    <div class="message-item">
                        <div class="message-header">
                            <h3 style="margin: 0;">${msg.title}</h3>
                            <button class="btn-danger btn-small" onclick="deleteMessage(${msg.id})">${tr.delete}</button>
                        </div>
                        <p style="margin: 10px 0;">${msg.content}</p>
                        <p class="message-time">${formatTime(msg.time)}</p>
                    </div>
                `).join('')}
            `;
        }

        function renderRooms(tr) {
            return `
                <div class="flex-between" style="margin-bottom: 20px;">
                    <h2 style="margin: 0;">${tr.rooms}</h2>
                    <button class="btn-primary btn-small" onclick="showAddPilgrimForm()">+ ${tr.addPilgrim}</button>
                </div>

                ${state.showAddPilgrim ? `
                    <div class="card" style="background: #f0fdf4;">
                        <h3>${tr.addPilgrim}</h3>
                        <input type="text" id="pilgrimName" placeholder="${tr.pilgrimName}">
                        <input type="text" id="roomNumber" placeholder="${tr.roomNumber}">
                        <input type="text" id="floorNumber" placeholder="${tr.floor}">
                        <div class="flex-row">
                            <button class="btn-primary" onclick="savePilgrim()">${tr.save}</button>
                            <button class="btn-secondary" onclick="hideAddPilgrimForm()">${tr.cancel}</button>
                        </div>
                    </div>
                ` : ''}

                ${state.pilgrims.length === 0 ? `
                    <p style="text-align: center; color: #6b7280; padding: 40px 0;">${tr.noPilgrims}</p>
                ` : state.pilgrims.map(pilgrim => `
                    <div class="pilgrim-item">
                        <div class="flex-between">
                            <div>
                                <h3 style="margin-bottom: 5px;">${pilgrim.name}</h3>
                                <div style="display: flex; gap: 10px; margin: 5px 0;">
                                    <span class="badge badge-info">${tr.room} ${pilgrim.room}</span>
                                    <span class="badge badge-info">${tr.floor} ${pilgrim.floor}</span>
                                </div>
                                <div style="margin-top: 10px;">
                                    ${pilgrim.online ? `<span class="status-online"></span><span style="font-size: 13px; color: #10b981;">${tr.online}</span>` : `<span class="status-offline"></span><span style="font-size: 13px; color: #6b7280;">${tr.offline}</span>`}
                                </div>
                            </div>
                            <button class="btn-danger btn-small" onclick="deletePilgrim(${pilgrim.id})">${tr.delete}</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderMap(tr) {
            return `
                <h2 style="margin-bottom: 20px;">${tr.map}</h2>
                <div class="card">
                    <div style="background: linear-gradient(135deg, #d1fae5 0%, #a5f3fc 100%); height: 300px; border-radius: 15px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                        <p style="color: #047857; font-weight: 600; z-index: 10;">Carte GPS interactive</p>
                        ${state.pilgrims.filter(p => p.online).map((pilgrim, idx) => `
                            <div style="position: absolute; left: ${30 + idx * 15}%; top: ${40 + idx * 10}%; width: 30px; height: 30px; background: #059669; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2);"></div>
                        `).join('')}
                    </div>
                </div>

                ${state.pilgrims.map(pilgrim => `
                    <div class="pilgrim-item">
                        <div class="flex-between">
                            <div>
                                <h3 style="margin: 0;">${pilgrim.name}</h3>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #6b7280;">
                                    ${pilgrim.online ? `<span class="status-online"></span>${tr.online}` : `<span class="status-offline"></span>${tr.offline}`}
                                </p>
                            </div>
                            ${pilgrim.online ? `<p style="color: #059669; font-weight: 600; margin: 0;">~${Math.floor(Math.random() * 500) + 100}m</p>` : ''}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderPresence(tr) {
            return `
                <div class="flex-between" style="margin-bottom: 20px;">
                    <h2 style="margin: 0;">${tr.presence}</h2>
                    <button class="btn-primary btn-small" onclick="showAddActivityForm()">+ ${tr.addActivity}</button>
                </div>

                ${state.showAddActivity ? `
                    <div class="card" style="background: #f0fdf4;">
                        <h3>${tr.addActivity}</h3>
                        <input type="text" id="activityName" placeholder="${tr.activityName}">
                        <input type="text" id="activityLocation" placeholder="${tr.activityLocation}">
                        <input type="time" id="activityTime" placeholder="${tr.activityTime}">
                        <div class="flex-row">
                            <button class="btn-primary" onclick="saveActivity()">${tr.save}</button>
                            <button class="btn-secondary" onclick="hideAddActivityForm()">${tr.cancel}</button>
                        </div>
                    </div>
                ` : ''}

                ${state.activities.length === 0 ? `
                    <p style="text-align: center; color: #6b7280; padding: 40px 0;">${tr.noActivities}</p>
                ` : state.activities.map(activity => {
                    const presentCount = Object.values(activity.presence || {}).filter(p => p).length;
                    return `
                        <div class="activity-item">
                            <div class="flex-between" style="margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 5px 0;">${activity.name}</h3>
                                    <p style="margin: 0; font-size: 14px; color: #6b7280;">📍 ${activity.location} • 🕐 ${activity.time}</p>
                                    <span class="badge badge-present">${presentCount} ${tr.presenceCount}</span>
                                </div>
                                <button class="btn-danger btn-small" onclick="deleteActivity(${activity.id})">${tr.delete}</button>
                            </div>
                            
                            <div style="margin-top: 15px; border-top: 2px solid #e5e7eb; padding-top: 15px;">
                                <h4 style="margin: 0 0 10px 0; color: #059669; font-size: 14px;">${tr.markPresence}</h4>
                                ${state.pilgrims.map(pilgrim => {
                                    const isPresent = activity.presence && activity.presence[pilgrim.id];
                                    return `
                                        <div class="checkbox-item">
                                            <input type="checkbox" 
                                                   ${isPresent ? 'checked' : ''} 
                                                   onchange="togglePresence(${activity.id}, ${pilgrim.id})">
                                            <span>${pilgrim.name}</span>
                                            ${isPresent ? `<span class="badge badge-present" style="margin-left: auto;">${tr.present}</span>` : `<span class="badge badge-absent" style="margin-left: auto;">${tr.absent}</span>`}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // Initialisation
        render();
    </script>
</body>
</html>
